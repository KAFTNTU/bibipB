<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RoboControl Car V10.0</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CORE BLOCKLY -->
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly/javascript_compressed.js"></script>
    <script src="https://unpkg.com/blockly/msg/uk.js"></script>

    <style>
        /* --- GLOBAL STYLES --- */
        body {
            overscroll-behavior: none;
            touch-action: none;
            user-select: none;
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: #0f172a;
            color: white;
            overflow: hidden; 
        }
        
        .glass-header {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        /* --- JOYSTICK --- */
        #joystick-container { 
            position: relative; 
            width: 280px; 
            height: 280px; 
            margin: 0 auto 5vh auto; 
        }
        #joystick-base {
            width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 70%);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.6), inset 0 0 20px rgba(0, 0, 0, 0.8);
            position: relative;
        }
        #joystick-stick {
            position: absolute; width: 90px; height: 90px;
            background: radial-gradient(circle at 30% 30%, #3b82f6, #1d4ed8);
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 8px 20px rgba(0,0,0,0.7);
            cursor: grab; z-index: 10;
            transition: transform 0.1s, background 0.2s, box-shadow 0.2s;
        }
        #joystick-stick.snap-back { transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #joystick-stick::after {
            content: ''; position: absolute; top: 20px; left: 20px; width: 25px; height: 25px;
            background: rgba(255,255,255,0.2); border-radius: 50%;
        }
        #joystick-stick.braking {
            background: radial-gradient(circle at 30% 30%, #ef4444, #b91c1c);
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.6);
        }

        .lock-btn { transition: all 0.3s; }
        .gyro-active { background-color: #8b5cf6 !important; box-shadow: 0 0 15px #8b5cf6; color: white !important; border-color: #8b5cf6 !important; animation: pulse-purple 2s infinite; }
        @keyframes pulse-purple {
            0% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(139, 92, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
        }

        /* --- SPEED SLIDER --- */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #3b82f6; cursor: pointer; margin-top: -8px; box-shadow: 0 0 10px rgba(59,130,246,0.5); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }

        /* --- QUAD JOYSTICK --- */
        .joy-quad-wrapper { display: flex; flex-direction: column; gap: 30px; align-items: center; }
        .joy-quad-label { font-size: 14px; color: #94a3b8; font-weight: bold; text-transform: uppercase; margin-bottom: 6px; text-align: center; }
        
        .joy-quad-container { width: 140px; height: 140px; position: relative; }
        
        .joy-quad-base { 
            width: 100%; height: 100%; 
            background: linear-gradient(to bottom, #1e293b 0%, #0f172a 100%); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 20px; 
            box-shadow: inset 0 0 15px rgba(0,0,0,0.8); 
            position: relative; touch-action: none; 
        }
        
        .joy-quad-stick { position: absolute; width: 56px; height: 56px; background: radial-gradient(circle at 30% 30%, #a855f7, #7e22ce); border-radius: 50%; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 10; pointer-events: none; }
        .joy-quad-stick.snap { transition: transform 0.2s; }

        /* --- BLOCKLY --- */
        #blocklyDiv { 
            position: absolute; 
            top: 64px; 
            left: 0; 
            right: 0; 
            bottom: 64px; 
            background-color: #0f172a !important; 
            z-index: 1;
        }
        
        .blocklySvg { background-color: transparent !important; }
        .blocklyToolboxDiv { 
            border: 1px solid rgba(255, 255, 255, 0.15); 
            position: absolute !important; 
            bottom: 20px !important; 
            left: 50% !important; 
            transform: translateX(-50%) !important; 
            top: auto !important; 
            height: 64px !important; 
            width: fit-content !important; 
            min-width: 300px; 
            max-width: 90vw; 
            display: flex !important; 
            flex-direction: row !important; 
            align-items: center; 
            justify-content: center; 
            border-radius: 16px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.6); 
            z-index: 40; 
            padding: 0 10px; 
        }
        .blocklyTreeRow { height: 48px !important; padding: 0 12px !important; margin: 0 4px !important; border-radius: 10px !important; cursor: pointer; display: flex; align-items: center; justify-content: center; border: 1px solid transparent; }
        .blocklyTreeLabel { font-family: 'Segoe UI', sans-serif; font-weight: 700; font-size: 13px !important; }
        
        .blocklyScrollbarHandle, .blocklyScrollbarBackground { display: none !important; pointer-events: none !important; opacity: 0 !important; }

        /* --- SENSOR DASHBOARD & BUTTONS --- */
        .sensor-row {
            position: absolute; 
            top: 75px; 
            left: 0;
            width: 100%;
            display: flex; 
            justify-content: center; 
            align-items: center;
            padding: 0 10px;
            gap: 12px; 
            z-index: 30;
            pointer-events: none; 
        }

        .sensor-dashboard {
            pointer-events: auto;
            background: rgba(15, 23, 42, 0.95);
            border-radius: 12px;
            padding: 4px 12px;
            display: flex; 
            justify-content: center;
            gap: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .sensor-item { display: flex; flex-direction: column; align-items: center; }
        .sensor-label { font-size: 8px; color: #94a3b8; font-weight: bold; text-transform: uppercase; white-space: nowrap; }
        .sensor-value { font-family: 'Courier New', monospace; font-size: 14px; font-weight: bold; color: #34d399; }

        /* Top Buttons */
        .top-btn {
            pointer-events: auto;
            width: 35px; height: 35px;
            border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
            cursor: pointer;
            color: white;
            font-size: 14px;
        }
        .top-btn:active { transform: scale(0.9); }
        
        .btn-example { background: #f59e0b; }
        .btn-run { background: #22c55e; }
        .btn-run.running { background: #ef4444; animation: pulse-red 2s infinite; }
        
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 14px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* UI Elements */
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ef4444; display: inline-block; transition: all 0.3s;}
        .connected { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .nav-btn { color: #64748b; padding: 8px 12px; border-radius: 8px; transition: all 0.2s; position: relative; }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: #94a3b8; }
        .nav-btn.active { color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
        
        .log-line { font-family: 'Courier New', monospace; font-size: 11px; padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-tx { color: #60a5fa; } .log-rx { color: #34d399; } .log-err { color: #f87171; }

        .key-hint { display: inline-block; padding: 2px 6px; background: #334155; border-radius: 4px; font-family: monospace; font-size: 10px; color: #94a3b8; border-bottom: 2px solid #1e293b; }
        
        .tune-check { display: flex; align-items: center; justify-content: space-between; background: #1e293b; padding: 10px; border-radius: 8px; border: 1px solid #334155; }
        .toggle-checkbox { appearance: none; width: 40px; height: 20px; background: #334155; border-radius: 20px; position: relative; cursor: pointer; transition: 0.3s; }
        .toggle-checkbox::after { content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle-checkbox:checked { background: #3b82f6; }
        .toggle-checkbox:checked::after { transform: translateX(20px); }
        
        .btn-check-label {
            flex: 1; text-align: center; padding: 10px; background: #334155; 
            border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;
            font-weight: bold; color: #94a3b8;
        }
        .btn-check-input:checked + .btn-check-label {
            background: #2563eb; color: white; border-color: #60a5fa;
        }
        .btn-check-input { display: none; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <!-- === HEADER === -->
    <header class="h-16 glass-header flex items-center justify-between px-4 z-50 absolute top-0 w-full">
        <div class="flex items-center gap-2">
            <span id="statusDot" class="status-dot"></span>
            <span id="statusText" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest hidden sm:block">OFFLINE</span>
        </div>
        
        <nav class="flex items-center gap-1 bg-slate-800/50 p-1 rounded-xl border border-slate-700/50">
            <button onclick="switchView('view-joystick', this)" class="nav-btn active" title="–ü—É–ª—å—Ç">
                <i class="fa-solid fa-gamepad text-lg"></i>
            </button>
            <button onclick="switchView('view-builder', this)" class="nav-btn" title="–ë–ª–æ–∫–∏">
                <i class="fa-solid fa-puzzle-piece text-lg"></i>
            </button>
            <button onclick="startDualMode(this)" class="nav-btn text-purple-400 hover:text-purple-300" title="4 –î–∂–æ–π—Å—Ç–∏–∫–∏">
                <div class="grid grid-cols-2 gap-0.5" style="width: 18px; height: 18px;">
                    <div class="bg-current rounded-full opacity-70"></div>
                    <div class="bg-current rounded-full opacity-70"></div>
                    <div class="bg-current rounded-full opacity-70"></div>
                    <div class="bg-current rounded-full opacity-70"></div>
                </div>
            </button>
            <div class="w-px h-6 bg-slate-700 mx-1"></div>
            <button onclick="openPassModal()" class="nav-btn text-emerald-500/80 hover:text-emerald-400" title="–ü–∞—Ä–æ–ª—å">
                <i class="fa-solid fa-lock text-lg"></i>
            </button>
            <button id="btnLog" onclick="toggleLogModal()" class="nav-btn text-yellow-500/80 hover:text-yellow-400 relative" title="–õ–æ–≥ (–ó–∞—Ç–∏—Å–Ω–∏ 3—Å)">
                <i class="fa-solid fa-book text-lg"></i>
            </button>
        </nav>
        
        <button id="btConnect" class="w-10 h-10 rounded-full bg-blue-600 active:bg-blue-700 hover:bg-blue-500 text-white shadow-lg flex items-center justify-center transition-all border border-blue-400/30">
            <i class="fa-brands fa-bluetooth-b text-lg"></i>
        </button>
    </header>

    <!-- === MAIN CONTENT === -->
    <main class="flex-1 relative overflow-hidden bg-gradient-to-br from-slate-900 to-slate-950 pt-16">
        
        <!-- --- VIEW 1: JOYSTICK (MAIN) --- -->
        <section id="view-joystick" class="absolute inset-0 flex flex-col items-center justify-center p-4 transition-opacity duration-300">
            
            <div id="joystick-container" class="mb-2">
                <div id="joystick-base">
                    <div id="joystick-stick" class="snap-back"></div>
                </div>
            </div>
            
            <div class="text-center mb-4 opacity-50 hidden md:block">
                <span class="key-hint">W</span> <span class="key-hint">A</span> <span class="key-hint">S</span> <span class="key-hint">D</span> –¥–ª—è —Ä—É—Ö—É
            </div>

            <div class="w-full max-w-xs flex flex-col gap-3 bg-slate-800/40 p-4 rounded-2xl border border-slate-700/30 backdrop-blur-sm">
                
                <div class="flex items-center justify-between gap-4">
                    <div class="bg-slate-900 px-3 py-1.5 rounded-lg border border-slate-700 text-center flex-1">
                        <span class="text-[10px] text-green-500 font-bold mr-1">L</span>
                        <span id="motorLDisplay" class="text-blue-400 font-mono font-bold">0</span>
                    </div>
                    
                    <button id="gyroBtn" class="lock-btn w-10 h-10 rounded-full bg-slate-700 text-slate-400 flex items-center justify-center shadow-md border border-slate-600 hover:bg-slate-600 active:scale-95" onclick="toggleGyro()" title="–ì—ñ—Ä–æ—Å–∫–æ–ø (–Ω–∞—Ç–∏—Å–Ω–∏ —â–æ–± –æ–±–Ω—É–ª–∏—Ç–∏)">
                        <i class="fa-solid fa-mobile-screen-button text-sm"></i>
                    </button>

                    <div class="bg-slate-900 px-3 py-1.5 rounded-lg border border-slate-700 text-center flex-1">
                        <span class="text-[10px] text-green-500 font-bold mr-1">R</span>
                        <span id="motorRDisplay" class="text-blue-400 font-mono font-bold">0</span>
                    </div>
                </div>

                <div class="pt-2 border-t border-white/5">
                    <div class="flex justify-between text-[10px] text-slate-400 mb-1 uppercase tracking-wide">
                        <span>–ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å</span>
                        <span id="speedVal">100%</span>
                    </div>
                    <input type="range" id="speedSlider" min="10" max="100" value="100" step="10">
                </div>
                
                <button onclick="document.getElementById('tuningModal').classList.remove('hidden')" class="w-full py-2 mt-1 rounded-lg bg-slate-700 hover:bg-slate-600 text-xs font-bold text-slate-300 border border-slate-600 transition-colors flex items-center justify-center gap-2">
                    <i class="fa-solid fa-sliders"></i> –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–æ—Ç–æ—Ä—ñ–≤
                </button>

                <div class="bg-black/40 px-3 py-1 rounded text-[10px] font-mono tracking-widest text-slate-400 border border-slate-800/50 text-center mt-2">
                    HEX: <span id="joyHex" class="text-yellow-500 font-bold">00 00 00 00</span>
                </div>
            </div>
        </section>


        <!-- --- VIEW 2: BUILDER (SCRATCH) --- -->
        <section id="view-builder" class="absolute inset-0 flex flex-col hidden opacity-0 transition-opacity duration-300">
            
            <div class="sensor-row">
                <button onclick="openExampleModal()" class="top-btn btn-example" title="–ì–æ—Ç–æ–≤—ñ –∑–±—ñ—Ä–∫–∏">
                    <i class="fa-solid fa-folder-open"></i>
                </button>

                <div class="sensor-dashboard" id="sensorDashboard">
                    <div class="sensor-item">
                        <span class="sensor-label">Port 1</span>
                        <span id="valP1" class="sensor-value">0</span>
                    </div>
                    <div class="w-px bg-slate-700"></div>
                    <div class="sensor-item">
                        <span class="sensor-label">Port 2</span>
                        <span id="valP2" class="sensor-value">0</span>
                    </div>
                    <div class="w-px bg-slate-700"></div>
                    <div class="sensor-item">
                        <span class="sensor-label">Port 3</span>
                        <span id="valP3" class="sensor-value">0</span>
                    </div>
                    <div class="w-px bg-slate-700"></div>
                    <div class="sensor-item">
                        <span class="sensor-label">Port 4</span>
                        <span id="valP4" class="sensor-value">0</span>
                    </div>
                </div>

                <button id="globalRunBtn" class="top-btn btn-run" onclick="toggleRunState()" title="–ó–∞–ø—É—Å–∫/–°—Ç–æ–ø">
                     <i class="fa-solid fa-play" id="runIcon"></i>
                </button>
            </div>

            <div id="blocklyDiv" class="flex-1 mt-0"></div>
        </section>

        <!-- --- VIEW 3: QUAD MODE --- -->
        <section id="view-dual" class="absolute inset-0 hidden opacity-0 flex flex-col items-center justify-center bg-slate-950">
             <div class="absolute top-0 w-full h-12 bg-slate-900/50 flex justify-between items-center px-6 border-b border-white/5 backdrop-blur-sm z-10">
                <div class="flex items-center gap-2">
                    <span class="w-2 h-2 bg-purple-500 rounded-full"></span>
                    <span class="text-xs text-purple-400 font-bold tracking-[0.2em] uppercase">4 Motor Control</span>
                </div>
            </div>

            <div class="w-full h-full flex items-center justify-center gap-8 px-4 pt-10">
                
                <div class="joy-quad-wrapper">
                    <div>
                        <div class="joy-quad-label">M1 (–ü–µ—Ä–µ–¥)</div>
                        <div id="joy1-container" class="joy-quad-container">
                            <div id="joy1-base" class="joy-quad-base">
                                <div id="joy1-stick" class="joy-quad-stick snap"></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="joy-quad-label">M3 (–ó–∞–¥)</div>
                        <div id="joy3-container" class="joy-quad-container">
                            <div id="joy3-base" class="joy-quad-base">
                                <div id="joy3-stick" class="joy-quad-stick snap"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="joy-quad-wrapper">
                    <div>
                        <div class="joy-quad-label">M2 (–ü–µ—Ä–µ–¥)</div>
                        <div id="joy2-container" class="joy-quad-container">
                            <div id="joy2-base" class="joy-quad-base">
                                <div id="joy2-stick" class="joy-quad-stick snap"></div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="joy-quad-label">M4 (–ó–∞–¥)</div>
                        <div id="joy4-container" class="joy-quad-container">
                            <div id="joy4-base" class="joy-quad-base">
                                <div id="joy4-stick" class="joy-quad-stick snap"></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            
            <div class="absolute bottom-28 bg-black/80 px-6 py-2 rounded-full text-xs font-mono text-purple-400 border border-slate-700 shadow-lg z-20">
                HEX: <span id="quadPacketHex">--</span>
            </div>
        </section>
    </main>


    <!-- === MODALS === -->
    
    <div id="exampleModal" class="fixed inset-0 bg-black/80 z-[70] hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-slate-900 w-full max-w-sm rounded-2xl shadow-2xl border border-slate-700 p-6 overflow-y-auto max-h-[90vh]">
            <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-folder-open text-amber-500"></i> –ì–æ—Ç–æ–≤—ñ –∑–±—ñ—Ä–∫–∏</h3>
            <div class="space-y-3">
                <button onclick="loadExample('autopilot')" class="w-full text-left p-3 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 transition-all flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center"><i class="fa-solid fa-robot"></i></div>
                    <div>
                        <div class="font-bold text-sm text-slate-200">–ê–≤—Ç–æ–ø—ñ–ª–æ—Ç –∑ –¥–∞—Ç—á–∏–∫–æ–º</div>
                        <div class="text-[10px] text-slate-500">–á–¥–µ —ñ –æ–±'—ó–∂–¥–∂–∞—î –ø–µ—Ä–µ—à–∫–æ–¥–∏</div>
                    </div>
                </button>
                <button onclick="loadExample('square')" class="w-full text-left p-3 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 transition-all flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center"><i class="fa-regular fa-square"></i></div>
                    <div>
                        <div class="font-bold text-sm text-slate-200">–†—É—Ö –∫–≤–∞–¥—Ä–∞—Ç–æ–º</div>
                        <div class="text-[10px] text-slate-500">–¢–µ—Å—Ç –ø–æ–≤–æ—Ä–æ—Ç—ñ–≤ –Ω–∞ 90 –≥—Ä–∞–¥—É—Å—ñ–≤</div>
                    </div>
                </button>
                 <button onclick="loadExample('line_follow')" class="w-full text-left p-3 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 transition-all flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-purple-500/20 text-purple-400 flex items-center justify-center"><i class="fa-solid fa-road"></i></div>
                    <div>
                        <div class="font-bold text-sm text-slate-200">–°–ª—ñ–¥—É–≤–∞–Ω–Ω—è –∑–∞ –ª—ñ–Ω—ñ—î—é</div>
                        <div class="text-[10px] text-slate-500">–ü—Ä–æ—Å—Ç–∞ –ª–æ–≥—ñ–∫–∞ –¥–ª—è —Ç—Ä–µ–∫—É</div>
                    </div>
                </button>
            </div>

            <div class="mt-6 pt-4 border-t border-slate-700">
                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3 flex items-center gap-2">
                    <i class="fa-solid fa-file-code"></i> –ú–æ—ó —Ñ–∞–π–ª–∏
                </h3>
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="newProject()" class="p-3 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 transition-all flex flex-col items-center justify-center gap-2 group">
                        <i class="fa-solid fa-trash text-red-400 text-xl group-hover:scale-110 transition-transform"></i>
                        <div class="text-xs font-bold text-slate-300">–ù–æ–≤–∏–π</div>
                    </button>
                    <button onclick="saveMyFile()" class="p-3 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 transition-all flex flex-col items-center justify-center gap-2 group">
                        <i class="fa-solid fa-download text-blue-400 text-xl group-hover:scale-110 transition-transform"></i>
                        <div class="text-xs font-bold text-slate-300">–ó–±–µ—Ä–µ–≥—Ç–∏</div>
                    </button>
                    <button onclick="document.getElementById('fileInputAppend').click()" class="p-3 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 transition-all flex flex-col items-center justify-center gap-2 group">
                        <i class="fa-solid fa-plus text-yellow-400 text-xl group-hover:scale-110 transition-transform"></i>
                        <div class="text-xs font-bold text-slate-300">–î–æ–¥–∞—Ç–∏</div>
                    </button>
                    <button onclick="document.getElementById('fileInputReplace').click()" class="p-3 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700 transition-all flex flex-col items-center justify-center gap-2 group">
                        <i class="fa-solid fa-folder-open text-green-400 text-xl group-hover:scale-110 transition-transform"></i>
                        <div class="text-xs font-bold text-slate-300">–í—ñ–¥–∫—Ä–∏—Ç–∏</div>
                    </button>
                </div>
            </div>

            <button onclick="document.getElementById('exampleModal').classList.add('hidden')" class="w-full mt-6 py-3 rounded-xl bg-slate-800 text-slate-400 hover:text-white border border-slate-700 font-bold text-sm">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        </div>
    </div>
    
    <input type="file" id="fileInputReplace" accept=".xml" style="display: none" onchange="loadMyFile(this, false)">
    <input type="file" id="fileInputAppend" accept=".xml" style="display: none" onchange="loadMyFile(this, true)">

    <div id="tuningModal" class="fixed inset-0 bg-black/90 z-[80] hidden flex items-center justify-center backdrop-blur-md p-4">
        <div class="bg-slate-900 w-full max-w-sm rounded-2xl shadow-2xl border border-slate-700 p-5 overflow-y-auto max-h-[90vh]">
            <h3 class="text-lg font-bold text-white mb-4 text-center">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —à–∞—Å—ñ</h3>
            
            <div class="space-y-4">
                 <div class="bg-purple-900/20 p-3 rounded-xl border border-purple-500/30">
                    <label class="tune-check bg-transparent border-0 p-0">
                        <span class="text-sm text-purple-300 font-bold"><i class="fa-solid fa-shield-halved mr-2"></i>SLIP –ü—Ä–æ—Ç–æ–∫–æ–ª</span>
                        <input type="checkbox" id="slipCheck" class="toggle-checkbox" onchange="saveTuning()">
                    </label>
                </div>

                <div class="bg-blue-900/20 p-3 rounded-xl border border-blue-500/30">
                    <label class="tune-check bg-transparent border-0 p-0">
                        <span class="text-sm text-blue-300 font-bold"><i class="fa-solid fa-truck-monster mr-2"></i>–†–µ–∂–∏–º 4 –º–æ—Ç–æ—Ä—ñ–≤ (4WD)</span>
                        <input type="checkbox" id="fourWdCheck" class="toggle-checkbox" onchange="saveTuning()">
                    </label>
                </div>

                <div class="space-y-2">
                    <span class="text-xs text-slate-400 uppercase tracking-widest font-bold">–Ü–Ω–≤–µ—Ä—Å—ñ—è –º–æ—Ç–æ—Ä—ñ–≤</span>
                    <div class="flex gap-2">
                        <input type="checkbox" id="invLCheck" class="btn-check-input" onchange="saveTuning()">
                        <label for="invLCheck" class="btn-check-label">L (–õ—ñ–≤–∏–π)</label>
                        
                        <input type="checkbox" id="invRCheck" class="btn-check-input" onchange="saveTuning()">
                        <label for="invRCheck" class="btn-check-label">R (–ü—Ä–∞–≤–∏–π)</label>
                    </div>
                </div>

                <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                    <div class="flex justify-between text-xs text-slate-400 mb-2">
                        <span>–õ—ñ–≤–æ</span>
                        <span class="font-bold text-white">–í–Ü–î–•–ò–õ–ï–ù–ù–Ø (–ë–ê–õ–ê–ù–°)</span>
                        <span>–ü—Ä–∞–≤–æ</span>
                    </div>
                    <input type="range" id="trimSlider" min="-50" max="50" value="0" step="1" oninput="updateTrimDisplay(this.value)">
                    <div class="text-center text-xs text-blue-400 font-mono mt-1" id="trimValueDisplay">0</div>
                </div>
                
                <div class="bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                    <div class="flex justify-between text-xs text-slate-400 mb-2">
                        <span>–ü–ª–∞–≤–Ω–∏–π</span>
                        <span class="font-bold text-white">–ß–£–¢–õ–ò–í–Ü–°–¢–¨ –ü–û–í–û–†–û–¢–£</span>
                        <span>–†—ñ–∑–∫–∏–π</span>
                    </div>
                    <input type="range" id="turnSensSlider" min="10" max="100" value="100" step="10" oninput="updateTrimDisplay(null)">
                    <div class="text-center text-xs text-blue-400 font-mono mt-1" id="turnSensDisplay">100%</div>
                </div>
            </div>

            <button onclick="document.getElementById('tuningModal').classList.add('hidden')" class="w-full mt-6 py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-500 shadow-lg">–ó–±–µ—Ä–µ–≥—Ç–∏ —Ç–∞ –∑–∞–∫—Ä–∏—Ç–∏</button>
        </div>
    </div>

    <div id="passModal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center backdrop-blur-md p-4">
        <div class="bg-slate-900 p-6 rounded-2xl w-full max-w-sm shadow-2xl border border-slate-700">
            <h3 class="text-lg font-bold text-white mb-6 text-center tracking-wide">–î–û–°–¢–£–ü</h3>
            <input type="text" id="passInput" class="w-full bg-slate-950 border border-slate-700 rounded-xl pl-10 pr-4 py-4 text-white focus:border-blue-500 outline-none text-center text-xl tracking-[0.5em] font-mono" placeholder="****">
            <div class="grid grid-cols-2 gap-3 mt-4">
                <button onclick="closePassModal()" class="py-3 rounded-xl bg-slate-800 text-slate-400 hover:bg-slate-700">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button onclick="sendPassword()" class="py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-500 shadow-lg">OK</button>
            </div>
        </div>
    </div>

    <div id="logModal" class="fixed inset-0 bg-black/50 z-40 hidden flex items-end sm:items-center justify-center backdrop-blur-sm sm:p-4">
        <div class="bg-slate-900 w-full sm:max-w-md h-2/3 sm:h-[500px] sm:rounded-2xl rounded-t-2xl shadow-2xl border border-slate-700 flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-slate-800">
                <h3 class="text-sm font-bold text-yellow-500 flex items-center gap-2"><i class="fa-solid fa-book"></i> –°–ò–°–¢–ï–ú–ù–ò–ô –õ–û–ì</h3>
                <div class="flex gap-2">
                    <button onclick="clearLog()" class="text-slate-500 hover:text-white text-xs px-2"><i class="fa-solid fa-trash"></i></button>
                    <button onclick="toggleLogModal()" class="text-slate-500 hover:text-white text-lg"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <div id="logContainer" class="flex-1 overflow-y-auto p-4 space-y-1 bg-black/20 font-mono text-xs">
                <div class="text-slate-500 italic">-- –ñ—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π (–±—É—Ñ–µ—Ä 1500 —Å—Ç—Ä–æ–∫) --</div>
            </div>
        </div>
    </div>

    <!-- XML Blocks -->
    <xml id="toolbox" style="display: none">
        <category name="–†—É—Ö" colour="#4C97FF">
            <block type="start_hat"></block>
            <block type="robot_move">
                <value name="L"><shadow type="math_number_limited"><field name="NUM">100</field></shadow></value>
                <value name="R"><shadow type="math_number_limited"><field name="NUM">100</field></shadow></value>
            </block>
            <block type="robot_move_soft">
                <value name="TARGET"><shadow type="math_number_limited"><field name="NUM">100</field></shadow></value>
                <value name="SEC"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
            </block>
            <block type="robot_turn_timed">
                 <field name="DIR">LEFT</field>
                 <value name="SEC"><shadow type="math_number"><field name="NUM">0.5</field></shadow></value>
            </block>
            <block type="robot_set_speed">
                <value name="SPEED"><shadow type="math_number_limited"><field name="NUM">50</field></shadow></value>
            </block>
            <block type="robot_stop"></block>
            <block type="move_4_motors">
                <value name="M1"><shadow type="math_number_limited"><field name="NUM">100</field></shadow></value>
                <value name="M2"><shadow type="math_number_limited"><field name="NUM">100</field></shadow></value>
                <value name="M3"><shadow type="math_number_limited"><field name="NUM">100</field></shadow></value>
                <value name="M4"><shadow type="math_number_limited"><field name="NUM">100</field></shadow></value>
            </block>
            <block type="motor_single">
                <value name="SPEED"><shadow type="math_number_limited"><field name="NUM">100</field></shadow></value>
            </block>
            <block type="go_home"></block>
            <block type="record_start"></block>
            <block type="replay_track"></block>
            <block type="wait_start"></block>
            <block type="stop_at_start"></block>
        </category>
        
        <category name="üß† –õ–æ–≥—ñ–∫–∞" colour="%{BKY_LOGIC_HUE}">
            <block type="controls_if"></block>
            <block type="controls_if">
                <mutation else="1"></mutation>
            </block>
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
            <block type="logic_negate"></block>
            <block type="logic_boolean"></block>
            <block type="sensor_get"></block>
            <block type="logic_edge_detect"></block>
            <block type="logic_schmitt">
                <value name="VAL"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
                <value name="LOW"><shadow type="math_number"><field name="NUM">30</field></shadow></value>
                <value name="HIGH"><shadow type="math_number"><field name="NUM">70</field></shadow></value>
            </block>
        </category>
        <category name="–¶–∏–∫–ª–∏" colour="%{BKY_LOOPS_HUE}">
            <block type="controls_repeat_ext"><value name="TIMES"><shadow type="math_number"><field name="NUM">4</field></shadow></value></block>
            <block type="controls_whileUntil"></block>
            <block type="controls_for">
                <value name="FROM"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
                <value name="TO"><shadow type="math_number"><field name="NUM">10</field></shadow></value>
                <value name="BY"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
            </block>
            <block type="replay_loop">
                 <value name="TIMES"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
             </block>
             <block type="count_laps">
                 <value name="LAPS"><shadow type="math_number"><field name="NUM">3</field></shadow></value>
             </block>
        </category>
        <category name="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞" colour="%{BKY_MATH_HUE}">
            <block type="math_number"></block>
            <block type="math_arithmetic"></block>
            <block type="math_single"></block>
            <block type="math_random_int">
                <value name="FROM"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
                <value name="TO"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
            </block>
            <block type="math_pid">
                <value name="ERROR"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
                <value name="KP"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
                <value name="KI"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
                <value name="KD"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
            </block>
            <block type="math_smooth"></block>
        </category>
        <category name="–ö–æ–Ω—Ç—Ä–æ–ª—å" colour="#FFBF00">
            <block type="wait_until_sensor">
                <field name="SENS">0</field>
                <field name="OP">LT</field>
                <value name="VAL"><shadow type="math_number"><field name="NUM">20</field></shadow></value>
            </block>
            <block type="wait_seconds"><value name="SECONDS"><shadow type="math_number"><field name="NUM">1</field></shadow></value></block>
            <block type="timer_get"></block>
            <block type="timer_reset"></block>
        </category>
        <category name="–ó–º—ñ–Ω–Ω—ñ" colour="%{BKY_VARIABLES_HUE}" custom="VARIABLE"></category>
    </xml>

    <script>
        // === üé® –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø –ö–û–õ–¨–û–†–Ü–í ===
        const THEME_CONFIG = {
            menuBg: '#1f2937',      
            menuText: '#ffffff',    
            menuSelected: '#1f2937',
            flyoutBg: '#1f2937',    
            flyoutOpacity: 0.95     
        };

        // === GLOBAL STATE ===
        let isConnected = false;
        let device, characteristic;
        let isGyroEnabled = false;
        let activeView = 'view-joystick';
        
        let gyroCalibrated = false;
        let gyroOffset = { x: 0, y: 0 };
        
        let currentL = 0;
        let currentR = 0;
        let speedMultiplier = 1.0; 
        
        let lastJoyX = 0;
        let lastJoyY = 0;
        
        let tuning = { trim: 0, invertL: false, invertR: false, useSlip: true, use4Motors: false, turnSens: 100 };
        try {
            const saved = localStorage.getItem('roboTuning_v8');
            if(saved) tuning = { ...tuning, ...JSON.parse(saved) };
        } catch(e) {}
        
        document.getElementById('trimSlider').value = tuning.trim;
        document.getElementById('trimValueDisplay').innerText = tuning.trim > 0 ? `R+${tuning.trim}` : (tuning.trim < 0 ? `L${tuning.trim}` : '0');
        document.getElementById('invLCheck').checked = tuning.invertL;
        document.getElementById('invRCheck').checked = tuning.invertR;
        document.getElementById('slipCheck').checked = tuning.useSlip;
        document.getElementById('fourWdCheck').checked = tuning.use4Motors;
        document.getElementById('turnSensSlider').value = tuning.turnSens;
        document.getElementById('turnSensDisplay').innerText = tuning.turnSens + "%";

        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const btnConnect = document.getElementById('btConnect');
        const motorLDisplay = document.getElementById('motorLDisplay');
        const motorRDisplay = document.getElementById('motorRDisplay');
        const joyHex = document.getElementById('joyHex');
        const speedSlider = document.getElementById('speedSlider');
        const speedVal = document.getElementById('speedVal');
        const btnLog = document.getElementById('btnLog');

        // LONG PRESS FOR LOG
        let logPressTimer;
        btnLog.addEventListener('mousedown', () => {
            logPressTimer = setTimeout(() => {
                document.getElementById('logModal').classList.remove('hidden');
            }, 3000); 
        });
        btnLog.addEventListener('mouseup', () => clearTimeout(logPressTimer));
        btnLog.addEventListener('touchstart', (e) => {
            logPressTimer = setTimeout(() => {
                document.getElementById('logModal').classList.remove('hidden');
            }, 3000);
        });
        btnLog.addEventListener('touchend', () => clearTimeout(logPressTimer));

        // LOGGING FUNCTIONS
        function log(msg, type = 'info') {
            const container = document.getElementById('logContainer');
            if (container.childElementCount > 1500) {
                container.removeChild(container.firstElementChild);
            }
            const el = document.createElement('div');
            el.classList.add('log-line');
            if(type === 'tx') el.classList.add('log-tx');
            else if(type === 'rx') el.classList.add('log-rx');
            else if(type === 'err') el.classList.add('log-err');
            else el.classList.add('text-slate-400');
            
            const time = new Date().toLocaleTimeString().split(' ')[0];
            el.innerHTML = `<span class="opacity-50 text-[9px] mr-2">${time}</span>${msg}`;
            
            container.appendChild(el);
            container.scrollTop = container.scrollHeight;
        }
        function clearLog() { document.getElementById('logContainer').innerHTML = ''; }
        function toggleLogModal() { document.getElementById('logModal').classList.toggle('hidden'); }

        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            log(args.join(' '));
        };

        function updateTrimDisplay(val) {
            if(val !== null) tuning.trim = parseInt(val);
            tuning.turnSens = parseInt(document.getElementById('turnSensSlider').value);
            
            document.getElementById('trimValueDisplay').innerText = tuning.trim > 0 ? `R+${tuning.trim}` : (tuning.trim < 0 ? `L${tuning.trim}` : '0');
            document.getElementById('turnSensDisplay').innerText = tuning.turnSens + "%";
            saveTuning();
        }

        function saveTuning() {
            tuning.trim = parseInt(document.getElementById('trimSlider').value);
            tuning.invertL = document.getElementById('invLCheck').checked;
            tuning.invertR = document.getElementById('invRCheck').checked;
            tuning.useSlip = document.getElementById('slipCheck').checked;
            tuning.use4Motors = document.getElementById('fourWdCheck').checked;
            tuning.turnSens = parseInt(document.getElementById('turnSensSlider').value);
            localStorage.setItem('roboTuning_v8', JSON.stringify(tuning));
        }

        setInterval(() => {
            if (isConnected && activeView === 'view-joystick') {
                let m1 = currentL, m2 = currentR;
                let m3 = tuning.use4Motors ? currentL : 0;
                let m4 = tuning.use4Motors ? currentR : 0;
                sendDrivePacket(m1, m2, m3, m4);
            }
        }, 100);

        const SLIP_END = 0xC0;
        const SLIP_ESC = 0xDB;
        const SLIP_ESC_END = 0xDC;
        const SLIP_ESC_ESC = 0xDD;

        let rxBuffer = [];

        function slipEncode(dataArray) {
            let encoded = [];
            encoded.push(SLIP_END);
            for(let byte of dataArray) {
                if(byte === SLIP_END) { encoded.push(SLIP_ESC, SLIP_ESC_END); }
                else if(byte === SLIP_ESC) { encoded.push(SLIP_ESC, SLIP_ESC_ESC); }
                else { encoded.push(byte); }
            }
            encoded.push(SLIP_END);
            return new Uint8Array(encoded);
        }

        function processSlipData(byte) {
            if (byte === SLIP_END) {
                if (rxBuffer.length > 0) {
                    handlePacket(rxBuffer);
                    rxBuffer = [];
                }
            } else if (byte === SLIP_ESC) {
                rxBuffer.push(byte); 
            } else {
                if (rxBuffer.length > 0 && rxBuffer[rxBuffer.length - 1] === SLIP_ESC) {
                    rxBuffer.pop(); 
                    if (byte === SLIP_ESC_END) rxBuffer.push(SLIP_END);
                    else if (byte === SLIP_ESC_ESC) rxBuffer.push(SLIP_ESC);
                    else {
                        rxBuffer.push(byte);
                        log("SLIP Error: Bad Escape", "err");
                    }
                } else {
                    rxBuffer.push(byte);
                }
            }
        }

        function handlePacket(data) {
            if (data.length >= 4) {
                window.sensorData = data;
                if(document.getElementById('valP1')) document.getElementById('valP1').innerText = data[0];
                if(document.getElementById('valP2')) document.getElementById('valP2').innerText = data[1];
                if(document.getElementById('valP3')) document.getElementById('valP3').innerText = data[2];
                if(document.getElementById('valP4')) document.getElementById('valP4').innerText = data[3];
            } else {
                 let hexStr = data.map(b => b.toString(16).padStart(2,'0')).join(' ');
                 const str = new TextDecoder().decode(new Uint8Array(data)).trim();
                 log(`RX RAW: ${hexStr} / "${str}"`, 'rx');
            }
        }

        window.motorState = { m1:0, m2:0, m3:0, m4:0 };

        async function sendDrivePacket(m1, m2, m3, m4) {
            if (!isConnected && !window.isSimulating) return;
            window.motorState = { m1, m2, m3, m4 };

            if (window._isRecordingTrack) {
                let now = new Date().getTime();
                window._trackMemory.push({
                    t: now,
                    l: m1,
                    r: m2,
                    m3: m3,
                    m4: m4
                });
            }

            m1 = Math.max(-100, Math.min(100, parseInt(m1)));
            m2 = Math.max(-100, Math.min(100, parseInt(m2)));
            m3 = Math.max(-100, Math.min(100, parseInt(m3)));
            m4 = Math.max(-100, Math.min(100, parseInt(m4)));
            
            const raw = new Int8Array([m1, m2, m3, m4]); 

            if (isConnected && characteristic) {
                let finalPacket;
                if (tuning.useSlip) {
                    const uintView = new Uint8Array(raw.buffer);
                    finalPacket = slipEncode(uintView);
                } else {
                    finalPacket = raw;
                }
                try { await characteristic.writeValue(finalPacket); } catch(e) { log("TX Fail: " + e.message, 'err'); }
            }
        }

        async function sendRawPacket(data) {
             if (!isConnected || !characteristic) return;
             let finalPacket = data;
             if (tuning.useSlip) {
                 finalPacket = slipEncode(new Uint8Array(data.buffer));
             }
             try { await characteristic.writeValue(finalPacket); } catch(e) {}
        }

        async function sendTextData(str) {
            if (!isConnected || !characteristic) return;
            const raw = new TextEncoder().encode(str + '\n');
             let finalPacket = raw;
             if (tuning.useSlip) {
                 finalPacket = slipEncode(raw);
             }
            try { await characteristic.writeValue(finalPacket); log(`Cmd: ${str}`, 'tx'); } catch(e) { log(e, 'err'); }
        }

        btnConnect.addEventListener('click', async () => {
            if(isConnected) { if(device) device.gatt.disconnect(); return; }
            try {
                log('Scanning...', 'info');
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [0xFFE0, "6e400001-b5a3-f393-e0a9-e50e24dcca9e"]
                });
                device.addEventListener('gattserverdisconnected', () => {
                    isConnected = false; statusDot.classList.remove('connected'); statusText.innerText = "OFFLINE";
                    btnConnect.classList.remove('bg-red-600'); btnConnect.classList.add('bg-blue-600');
                    log('Disconnected', 'err');
                });
                const server = await device.gatt.connect();
                let service;
                try { service = await server.getPrimaryService(0xFFE0); characteristic = await service.getCharacteristic(0xFFE1); } 
                catch(e) { service = await server.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e"); characteristic = await service.getCharacteristic("6e400002-b5a3-f393-e0a9-e50e24dcca9e"); }

                try {
                    await characteristic.startNotifications();
                    characteristic.addEventListener('characteristicvaluechanged', (e) => {
                        const rawData = new Uint8Array(e.target.value.buffer);
                        
                        if (tuning.useSlip) {
                            for(let i=0; i<rawData.length; i++) {
                                processSlipData(rawData[i]);
                            }
                        } else {
                             handlePacket(Array.from(rawData));
                        }
                    });
                } catch(e){}

                isConnected = true; statusDot.classList.add('connected'); statusText.innerText = "ONLINE";
                btnConnect.classList.remove('bg-blue-600'); btnConnect.classList.add('bg-red-600');
                log('Connected!', 'info');
            } catch(e) { log(e, 'err'); }
        });

        function switchView(viewId, btnElement) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
            
            ['view-joystick', 'view-builder', 'view-dual'].forEach(id => {
                const el = document.getElementById(id);
                el.classList.add('hidden');
                el.classList.remove('opacity-100');
                el.classList.add('opacity-0');
            });
            const target = document.getElementById(viewId);
            target.classList.remove('hidden');
            setTimeout(() => { target.classList.remove('opacity-0'); target.classList.add('opacity-100'); }, 10);
            
            activeView = viewId;
            if(viewId !== 'view-joystick' && isGyroEnabled) toggleGyro();
            if(viewId === 'view-builder' && typeof Blockly !== 'undefined') setTimeout(() => Blockly.svgResize(workspace), 100);
        }
        function startDualMode(btn) { switchView('view-dual', btn); }

        function openPassModal() { document.getElementById('passModal').classList.remove('hidden'); }
        function closePassModal() { document.getElementById('passModal').classList.add('hidden'); }
        function sendPassword() {
            const pass = document.getElementById('passInput').value;
            if (pass) { sendTextData(`PASS:${pass}`); document.getElementById('passInput').value = ''; closePassModal(); }
        }
        function openExampleModal() { document.getElementById('exampleModal').classList.remove('hidden'); }

        const stick = document.getElementById('joystick-stick');
        const base = document.getElementById('joystick-base');
        const gyroBtn = document.getElementById('gyroBtn');
        let dragging = false;
        let joyCenter = { x: 0, y: 0 };
        const maxDist = 90;

        speedSlider.addEventListener('input', (e) => {
            const val = e.target.value;
            speedVal.innerText = val + '%';
            speedMultiplier = val / 100;
            updateTankLogic(lastJoyX, lastJoyY);
        });

        const keys = { w: false, a: false, s: false, d: false };
        document.addEventListener('keydown', (e) => { if(activeView!=='view-joystick')return; const k=e.key.toLowerCase(); if(keys.hasOwnProperty(k)){keys[k]=true; updateKeyboardLogic();} });
        document.addEventListener('keyup', (e) => { if(activeView!=='view-joystick')return; const k=e.key.toLowerCase(); if(keys.hasOwnProperty(k)){keys[k]=false; updateKeyboardLogic();} });
        function updateKeyboardLogic() {
            let x=0,y=0; if(keys.w)y=100; if(keys.s)y=-100; if(keys.a)x=-100; if(keys.d)x=100;
            if(y!==0&&x!==0)x*=0.5; 
            lastJoyX = x; lastJoyY = y;
            updateTankLogic(x,y);
        }

        function toggleGyro() {
            if (!window.DeviceOrientationEvent) { alert("–ù–µ–º–∞—î –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –≥—ñ—Ä–æ—Å–∫–æ–ø–∞"); return; }
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(s => { if(s==='granted') activateGyro(); else alert("–í—ñ–¥–º–æ–≤–ª–µ–Ω–æ"); });
            } else { activateGyro(); }
        }
        function activateGyro() {
            isGyroEnabled = !isGyroEnabled;
            if (isGyroEnabled) {
                gyroBtn.classList.add('gyro-active'); 
                gyroCalibrated = false; 
                window.addEventListener('deviceorientation', handleGyro);
            } else {
                gyroBtn.classList.remove('gyro-active'); window.removeEventListener('deviceorientation', handleGyro); resetJoystick();
            }
        }
        function handleGyro(e) {
            if (!isGyroEnabled) return;
            if (!gyroCalibrated) {
                gyroOffset.x = e.gamma;
                gyroOffset.y = e.beta;
                gyroCalibrated = true;
                return;
            }

            let x = e.gamma - gyroOffset.x;
            let y = e.beta - gyroOffset.y;
            
            const maxTilt = 30;
            if (x > maxTilt) x = maxTilt; if (x < -maxTilt) x = -maxTilt;
            if (y > maxTilt) y = maxTilt; if (y < -maxTilt) y = -maxTilt;
            
            let valX = Math.round((x / maxTilt) * 100);
            let valY = Math.round((y / maxTilt) * 100); 
            
            if (Math.abs(valX) < 10) valX = 0; if (Math.abs(valY) < 10) valY = 0;
            valY = -valY;
            
            const moveX = (valX / 100) * maxDist;
            const moveY = (-valY / 100) * maxDist;
            stick.style.transform = `translate(-50%, -50%) translate(${moveX}px, ${moveY}px)`;
            
            lastJoyX = valX; lastJoyY = valY;
            updateTankLogic(valX, valY);
        }

        function startJoy(e) { if(activeView!=='view-joystick'||isGyroEnabled)return; dragging=true; stick.classList.remove('snap-back'); const r=base.getBoundingClientRect(); joyCenter={x:r.left+r.width/2,y:r.top+r.height/2}; stick.classList.add('braking'); }
        function endJoy() { if(activeView!=='view-joystick'||isGyroEnabled)return; dragging=false; if(navigator.vibrate)navigator.vibrate(5); stick.classList.remove('braking'); resetJoystick(); }
        function resetJoystick() { 
            stick.classList.add('snap-back'); 
            stick.style.transform = `translate(-50%, -50%)`; 
            lastJoyX = 0; lastJoyY = 0;
            updateTankLogic(0,0); 
        }
        function moveJoy(e) {
            if(!dragging||isGyroEnabled)return; e.preventDefault();
            const cx=e.touches?e.touches[0].clientX:e.clientX; const cy=e.touches?e.touches[0].clientY:e.clientY;
            const dx=cx-joyCenter.x; const dy=cy-joyCenter.y;
            const dist=Math.min(Math.hypot(dx,dy),maxDist); const angle=Math.atan2(dy,dx);
            
            if(dist<10) stick.classList.add('braking'); else stick.classList.remove('braking');
            
            const mx=Math.cos(angle)*dist; const my=Math.sin(angle)*dist;
            stick.style.transform=`translate(-50%,-50%) translate(${mx}px,${my}px)`;
            
            const vx=Math.round((mx/maxDist)*100); const vy=Math.round((my/maxDist)*100)*-1;
            lastJoyX = vx; lastJoyY = vy;
            updateTankLogic(vx,vy);
        }
        
        function updateTankLogic(vx, vy) {
            vx = Math.round(vx * (tuning.turnSens / 100));

            let vL = vy + vx; 
            let vR = vy - vx;
            
            if (tuning.trim > 0) vR = vR * (1 - (tuning.trim / 100));
            else if (tuning.trim < 0) vL = vL * (1 - (Math.abs(tuning.trim) / 100));
            if (tuning.invertL) vL = -vL;
            if (tuning.invertR) vR = -vR;
            
            vL = Math.max(-100, Math.min(100, vL));
            vR = Math.max(-100, Math.min(100, vR));

            vL = Math.round(vL * speedMultiplier);
            vR = Math.round(vR * speedMultiplier);
            
            currentL = vL; currentR = vR;
            motorLDisplay.innerText = currentL; 
            motorRDisplay.innerText = currentR;
            
            let hex = "";
            if (tuning.use4Motors) {
                const raw = new Int8Array([currentL, currentR, currentL, currentR]);
                const uintView = new Uint8Array(raw.buffer); 
                for(let b of uintView) hex += b.toString(16).toUpperCase().padStart(2,'0') + " ";
            } else {
                const raw = new Int8Array([currentL, currentR, 0, 0]);
                const uintView = new Uint8Array(raw.buffer); 
                for(let b of uintView) hex += b.toString(16).toUpperCase().padStart(2,'0') + " ";
            }
            joyHex.innerText = hex;
        }

        base.addEventListener('mousedown', startJoy); base.addEventListener('touchstart', startJoy);
        window.addEventListener('mouseup', endJoy); window.addEventListener('touchend', endJoy);
        window.addEventListener('mousemove', moveJoy); window.addEventListener('touchmove', moveJoy, {passive:false});

        const quadState = { m1:0, m2:0, m3:0, m4:0 };
        
        function initQuadJoystick(id) {
            const base = document.getElementById(`joy${id}-base`);
            const stick = document.getElementById(`joy${id}-stick`);
            if(!base || !stick) return;
            
            const maxDist = 42; 
            let activeTouchId = null;

            function update(cx, cy) {
                const rect = base.getBoundingClientRect();
                const dy = cy - (rect.top + rect.height/2);
                
                let my = dy;
                if(my > maxDist) my = maxDist;
                if(my < -maxDist) my = -maxDist;
                
                stick.style.transform = `translate(-50%, -50%) translate(0px, ${my}px)`;
                
                let speed = Math.round((my/maxDist)*100) * -1; 
                quadState[`m${id}`] = speed;
            }

            function reset() {
                stick.classList.add('snap');
                stick.style.transform = `translate(-50%, -50%)`;
                quadState[`m${id}`] = 0;
            }

            base.addEventListener('mousedown', (e) => {
                stick.classList.remove('snap'); update(e.clientX, e.clientY);
                const mm = (ev) => update(ev.clientX, ev.clientY);
                const mu = () => { window.removeEventListener('mousemove', mm); window.removeEventListener('mouseup', mu); reset(); };
                window.addEventListener('mousemove', mm); window.addEventListener('mouseup', mu);
            });

            base.addEventListener('touchstart', (e) => { 
                e.preventDefault(); 
                stick.classList.remove('snap'); 
                activeTouchId = e.changedTouches[0].identifier; 
                update(e.changedTouches[0].clientX, e.changedTouches[0].clientY); 
            });
            base.addEventListener('touchmove', (e) => { 
                e.preventDefault(); 
                for(let i=0; i<e.changedTouches.length; i++) { 
                    if(e.changedTouches[i].identifier === activeTouchId) { 
                        update(e.changedTouches[i].clientX, e.changedTouches[i].clientY); 
                        break; 
                    } 
                } 
            });
            base.addEventListener('touchend', (e) => { 
                e.preventDefault(); 
                for(let i=0; i<e.changedTouches.length; i++) { 
                    if(e.changedTouches[i].identifier === activeTouchId) { 
                        activeTouchId = null; 
                        reset(); 
                        break; 
                    } 
                } 
            });
        }

        setTimeout(() => { 
            initQuadJoystick(1); 
            initQuadJoystick(2); 
            initQuadJoystick(3); 
            initQuadJoystick(4); 
        }, 500);

        setInterval(() => {
            if(activeView === 'view-dual') {
                const packet = new Int8Array([quadState.m1, quadState.m2, quadState.m3, quadState.m4]); 
                let hexStr = "";
                const uintView = new Uint8Array(packet.buffer);
                for(let b of uintView) hexStr += b.toString(16).toUpperCase().padStart(2, '0') + " ";
                document.getElementById('quadPacketHex').innerText = hexStr;
                
                if(isConnected) sendRawPacket(packet);
            }
        }, 100);

        const CustomTheme = Blockly.Theme.defineTheme('myTheme', {
            'base': Blockly.Themes.Classic,
            'componentStyles': {
                'workspaceBackgroundColour': '#0f172a', 'toolboxBackgroundColour': THEME_CONFIG.menuBg, 'toolboxForegroundColour': THEME_CONFIG.menuText, 'flyoutBackgroundColour': THEME_CONFIG.flyoutBg, 'flyoutForegroundColour': THEME_CONFIG.menuText, 'flyoutOpacity': THEME_CONFIG.flyoutOpacity, 'scrollbarColour': '#334155', 'insertionMarkerColour': '#fff', 'insertionMarkerOpacity': 0.3
            }
        });

        var workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'), 
            theme: CustomTheme, 
            renderer: 'zelos', 
            horizontalLayout: true, 
            toolboxPosition: 'end', 
            grid: { spacing: 40, length: 2, colour: '#334155', snap: true }, 
            zoom: { controls: false, wheel: true, startScale: 0.75, maxScale: 30, minScale: 0.2, scaleSpeed: 1.2, pinch: true }, 
            trashcan: false, 
            move: { scrollbars: true, drag: true, wheel: false }
        });
        
        setTimeout(() => {
            const style = document.createElement('style');
            style.innerHTML = `.blocklyToolboxDiv { background-color: ${THEME_CONFIG.menuBg} !important; } .blocklyFlyoutBackground { fill: ${THEME_CONFIG.flyoutBg} !important; fill-opacity: ${THEME_CONFIG.flyoutOpacity} !important; } .blocklyTreeLabel { color: ${THEME_CONFIG.menuText} !important; } .blocklyTreeSelected .blocklyTreeRow { background-color: ${THEME_CONFIG.menuSelected} !important; }`;
            document.head.appendChild(style);
        }, 500);

        function checkStop() {
            return `if (typeof window._shouldStop !== 'undefined' && window._shouldStop) { throw "STOPPED"; }\n`;
        }

        Blockly.Blocks['start_hat'] = {
            init: function() {
                this.appendDummyInput().appendField("üèÅ –°–¢–ê–†–¢");
                this.setNextStatement(true);
                this.setColour(120);
            }
        };
        javascript.javascriptGenerator.forBlock['start_hat'] = function(b) { return ''; };

        Blockly.Blocks['record_start'] = {
            init: function() {
                this.appendDummyInput().appendField("üî¥ –ó–∞–ø–∞–º'—è—Ç–∞—Ç–∏ —Ç—Ä–∞—Å—É (–ü–æ—á–∞—Ç–∏ –∑–∞–ø–∏—Å)");
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour(260); 
            }
        };
        javascript.javascriptGenerator.forBlock['record_start'] = function(block) {
            return `
            window._trackMemory = [];
            window._isRecordingTrack = true;
            console.log("Recording started...");
            \n`;
        };

        Blockly.Blocks['replay_track'] = {
            init: function() {
                this.appendDummyInput().appendField("‚ñ∂Ô∏è –í—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø–∏—Å–∞–Ω—É —Ç—Ä–∞—Å—É");
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour(260); 
            }
        };
        javascript.javascriptGenerator.forBlock['replay_track'] = function(block) {
            return `
            window._isRecordingTrack = false; 
            console.log("Replaying track, steps: " + window._trackMemory.length);
            
            if (window._trackMemory.length > 0) {
                let startTime = window._trackMemory[0].t;
                for (let i = 0; i < window._trackMemory.length; i++) {
                    ${checkStop()}
                    let step = window._trackMemory[i];
                    
                    if (i > 0) {
                        let prev = window._trackMemory[i-1];
                        let delay = step.t - prev.t;
                        if (delay > 0) await new Promise(r => setTimeout(r, delay));
                    }
                    
                    await sendDrivePacket(step.l, step.r, step.m3, step.m4);
                }
                await sendDrivePacket(0,0,0,0);
            }
            \n`;
        };
        
        Blockly.Blocks['replay_loop'] = {
            init: function() {
                this.appendDummyInput().appendField("üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç–∏ —Ç—Ä–∞—Å—É –∑ –ø–∞–º'—è—Ç—ñ");
                this.appendValueInput("TIMES").setCheck("Number");
                this.appendDummyInput().appendField("—Ä–∞–∑—ñ–≤");
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour(260); 
            }
        };
        javascript.javascriptGenerator.forBlock['replay_loop'] = function(block) {
            let times = javascript.javascriptGenerator.valueToCode(block, 'TIMES', javascript.Order.ATOMIC) || '1';
            return `
            window._isRecordingTrack = false;
            for(let loop=0; loop < ${times}; loop++) {
                ${checkStop()}
                if (window._trackMemory.length > 0) {
                    for (let i = 0; i < window._trackMemory.length; i++) {
                        ${checkStop()}
                        let step = window._trackMemory[i];
                        if (i > 0) {
                            let prev = window._trackMemory[i-1];
                            let delay = step.t - prev.t;
                            if (delay > 0) await new Promise(r => setTimeout(r, delay));
                        }
                        await sendDrivePacket(step.l, step.r, step.m3, step.m4);
                    }
                    await sendDrivePacket(0,0,0,0);
                    await new Promise(r => setTimeout(r, 500));
                }
            }
            \n`;
        };

        Blockly.Blocks['wait_start'] = {
            init: function() {
                this.appendDummyInput().appendField("üèÅ –ß–µ–∫–∞—Ç–∏ –°—Ç–∞—Ä—Ç (–ß–æ—Ä–Ω–∞ –ª—ñ–Ω—ñ—è)");
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour(40); 
            }
        };
        javascript.javascriptGenerator.forBlock['wait_start'] = function(block) {
            return `
            console.log("Waiting for start line...");
            while(true) {
                ${checkStop()}
                let s1 = window.sensorData ? window.sensorData[0] : 0; 
                let s2 = window.sensorData ? window.sensorData[1] : 0; 
                if (s1 > 60 || s2 > 60) break;
                await new Promise(r => setTimeout(r, 50));
            }
            console.log("Start line detected!");
            \n`;
        };

        // === FIXED LAYOUT ===
        Blockly.Blocks['count_laps'] = {
            init: function() {
                this.appendValueInput("LAPS")
                    .setCheck("Number")
                    .appendField("üî¢ –õ—ñ—á–∏—Ç–∏ –∫–æ–ª–∞ –¥–æ"); 
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour(40); 
            }
        };
        javascript.javascriptGenerator.forBlock['count_laps'] = function(block) {
            let laps = javascript.javascriptGenerator.valueToCode(block, 'LAPS', javascript.Order.ATOMIC) || '1';
            return `
            let lapsTarget = ${laps};
            let lapsCounted = 0;
            let onLine = false;
            
            console.log("Counting laps: " + lapsTarget);
            
            while(lapsCounted < lapsTarget) {
                ${checkStop()}
                let s = (window.sensorData && window.sensorData[0] > 60); 
                
                if (s && !onLine) {
                    onLine = true;
                    lapsCounted++;
                    console.log("Lap " + lapsCounted);
                } else if (!s && onLine) {
                    onLine = false;
                }
                await new Promise(r => setTimeout(r, 50));
            }
            \n`;
        };

        Blockly.Blocks['stop_at_start'] = {
            init: function() {
                this.appendDummyInput().appendField("üõë –ó—É–ø–∏–Ω–∏—Ç–∏—Å—è –Ω–∞ —Å—Ç–∞—Ä—Ç—ñ");
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour(0); 
            }
        };
        javascript.javascriptGenerator.forBlock['stop_at_start'] = function(block) {
            return `
            while(true) {
                ${checkStop()}
                let s1 = window.sensorData ? window.sensorData[0] : 0;
                if (s1 > 60) break; 
                await new Promise(r => setTimeout(r, 20));
            }
            await sendDrivePacket(0,0,0,0);
            \n`;
        };

        Blockly.Blocks['robot_turn_timed'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("üîÑ –ü–æ–≤–æ—Ä–æ—Ç")
                    .appendField(new Blockly.FieldDropdown([["–õ—ñ–≤–æ—Ä—É—á ‚¨ÖÔ∏è","LEFT"], ["–ü—Ä–∞–≤–æ—Ä—É—á ‚û°Ô∏è","RIGHT"]]), "DIR");
                this.appendValueInput("SEC").setCheck("Number").appendField("–Ω–∞");
                this.appendDummyInput().appendField("—Å–µ–∫");
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour(230); 
            }
        };
        javascript.javascriptGenerator.forBlock['robot_turn_timed'] = function(block) {
            var dir = block.getFieldValue('DIR');
            var sec = javascript.javascriptGenerator.valueToCode(block, 'SEC', javascript.Order.ATOMIC) || '0.5';
            
            var l = (dir === 'LEFT') ? -80 : 80;
            var r = (dir === 'LEFT') ? 80 : -80;
            
            return `
            ${checkStop()}
            recordMove(${l}, ${r}, ${l}, ${r}); 
            await sendDrivePacket(${l}, ${r}, ${l}, ${r});
            await new Promise(r => setTimeout(r, ${sec} * 1000));
            recordMove(0,0,0,0);
            await sendDrivePacket(0,0,0,0);
            \n`;
        };

        Blockly.Blocks['robot_set_speed'] = {
            init: function() {
                this.appendDummyInput().appendField("‚ö° –®–≤–∏–¥–∫—ñ—Å—Ç—å");
                this.appendValueInput("SPEED").setCheck("Number");
                this.appendDummyInput().appendField("%");
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour(230); 
            }
        };
        javascript.javascriptGenerator.forBlock['robot_set_speed'] = function(block) {
            var s = javascript.javascriptGenerator.valueToCode(block, 'SPEED', javascript.Order.ATOMIC) || '100';
            return `_blocklySpeedMultiplier = ${s} / 100.0;\n`;
        };
        
        Blockly.Blocks['wait_until_sensor'] = {
             init: function() { 
                this.appendValueInput("VAL")
                    .setCheck("Number")
                    .appendField("‚è≥ –ß–µ–∫–∞—Ç–∏, –ø–æ–∫–∏ –ü–æ—Ä—Ç")
                    .appendField(new Blockly.FieldDropdown([["1","0"], ["2","1"], ["3","2"], ["4","3"]]), "SENS")
                    .appendField(new Blockly.FieldDropdown([["<", "LT"], [">", "GT"]]), "OP");
                this.setInputsInline(true);
                this.setPreviousStatement(true); 
                this.setNextStatement(true); 
                this.setColour(40);
            }
        };
        javascript.javascriptGenerator.forBlock['wait_until_sensor'] = function(block) {
            var s = block.getFieldValue('SENS');
            var op = block.getFieldValue('OP') === 'LT' ? '<' : '>';
            var val = javascript.javascriptGenerator.valueToCode(block, 'VAL', javascript.Order.ATOMIC) || '0';
            
            return `
            while(true) {
                ${checkStop()}
                var currentVal = window.sensorData ? window.sensorData[${s}] : 0;
                if (currentVal ${op} ${val}) break;
                await new Promise(r => setTimeout(r, 50)); 
            }
            \n`;
        };

        Blockly.Blocks['timer_get'] = {
            init: function() {
                this.appendDummyInput().appendField("‚è±Ô∏è –¢–∞–π–º–µ—Ä (—Å)");
                this.setOutput(true, "Number");
                this.setColour(40);
            }
        };
        javascript.javascriptGenerator.forBlock['timer_get'] = function(block) {
            return [`((new Date().getTime() - _startTime) / 1000)`, javascript.Order.ATOMIC];
        };

        Blockly.Blocks['timer_reset'] = {
            init: function() {
                this.appendDummyInput().appendField("üîÑ –°–∫–∏–Ω—É—Ç–∏ —Ç–∞–π–º–µ—Ä");
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour(40);
            }
        };
        javascript.javascriptGenerator.forBlock['timer_reset'] = function(block) {
            return `_startTime = new Date().getTime();\n`;
        };

        Blockly.Blocks['math_pid'] = {
            init: function() {
                this.appendDummyInput().appendField("üéõÔ∏è PID –†–µ–≥—É–ª—è—Ç–æ—Ä");
                this.appendValueInput("ERROR").setCheck("Number").appendField("–ü–æ–º–∏–ª–∫–∞");
                this.appendValueInput("KP").setCheck("Number").appendField("Kp");
                this.appendValueInput("KI").setCheck("Number").appendField("Ki");
                this.appendValueInput("KD").setCheck("Number").appendField("Kd");
                this.setOutput(true, "Number");
                this.setInputsInline(true); 
                this.setColour(230);
            }
        };
        javascript.javascriptGenerator.forBlock['math_pid'] = function(block) {
            var error = javascript.javascriptGenerator.valueToCode(block, 'ERROR', javascript.Order.ATOMIC) || '0';
            var kp = javascript.javascriptGenerator.valueToCode(block, 'KP', javascript.Order.ATOMIC) || '1';
            var ki = javascript.javascriptGenerator.valueToCode(block, 'KI', javascript.Order.ATOMIC) || '0';
            var kd = javascript.javascriptGenerator.valueToCode(block, 'KD', javascript.Order.ATOMIC) || '0';
            return [`calculatePID(${error}, ${kp}, ${ki}, ${kd})`, javascript.Order.FUNCTION_CALL];
        };

        Blockly.Blocks['logic_edge_detect'] = {
            init: function() {
                this.appendDummyInput().appendField("‚ö° –°–∏–≥–Ω–∞–ª —Å—Ç–∞–≤ –∞–∫—Ç–∏–≤–Ω–∏–º (0‚Üí1)");
                this.appendValueInput("VAL").setCheck(null).appendField("–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏");
                this.setOutput(true, "Boolean");
                this.setColour(210); 
                this.setInputsInline(true);
            }
        };
        javascript.javascriptGenerator.forBlock['logic_edge_detect'] = function(block) {
            var val = javascript.javascriptGenerator.valueToCode(block, 'VAL', javascript.Order.ATOMIC) || 'false';
            var id = block.id;
            return [`checkRisingEdge('${id}', ${val})`, javascript.Order.FUNCTION_CALL];
        };

        Blockly.Blocks['logic_schmitt'] = {
            init: function() {
                this.appendDummyInput().appendField("üõ°Ô∏è –í–∫–ª >");
                this.appendValueInput("HIGH").setCheck("Number");
                this.appendDummyInput().appendField("–í–∏–∫–ª <");
                this.appendValueInput("LOW").setCheck("Number");
                this.appendValueInput("VAL").setCheck("Number").appendField("–ó–Ω–∞—á–µ–Ω–Ω—è");
                this.setOutput(true, "Boolean");
                this.setColour(210);
                this.setInputsInline(true);
            }
        };
        javascript.javascriptGenerator.forBlock['logic_schmitt'] = function(block) {
            var val = javascript.javascriptGenerator.valueToCode(block, 'VAL', javascript.Order.ATOMIC) || '0';
            var low = javascript.javascriptGenerator.valueToCode(block, 'LOW', javascript.Order.ATOMIC) || '30';
            var high = javascript.javascriptGenerator.valueToCode(block, 'HIGH', javascript.Order.ATOMIC) || '70';
            var id = block.id;
            return [`schmittTrigger('${id}', ${val}, ${low}, ${high})`, javascript.Order.FUNCTION_CALL];
        };

        Blockly.Blocks['math_smooth'] = {
            init: function() {
                this.appendValueInput("VAL")
                    .setCheck("Number")
                    .appendField("üåä –ó–≥–ª–∞–¥–∏—Ç–∏");
                this.appendDummyInput()
                    .appendField("–ö-—Å—Ç—å:")
                    .appendField(new Blockly.FieldNumber(5, 2, 50), "SIZE");
                this.setOutput(true, "Number");
                this.setColour(230);
                this.setInputsInline(true);
            }
        };
        javascript.javascriptGenerator.forBlock['math_smooth'] = function(block) {
            var val = javascript.javascriptGenerator.valueToCode(block, 'VAL', javascript.Order.ATOMIC) || '0';
            var size = block.getFieldValue('SIZE');
            var id = block.id;
            return [`smoothValue('${id}', ${val}, ${size})`, javascript.Order.FUNCTION_CALL];
        };

        Blockly.Blocks['math_number_limited'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField(new Blockly.FieldNumber(100, -100, 100), "NUM"); 
                this.setOutput(true, "Number");
                this.setColour(230);
            }
        };
        javascript.javascriptGenerator.forBlock['math_number_limited'] = function(block) {
            return [block.getFieldValue('NUM'), javascript.Order.ATOMIC];
        };

        Blockly.Blocks['robot_move'] = { 
            init: function() { 
                this.appendDummyInput().appendField("üöó –á—Ö–∞—Ç–∏");
                this.appendValueInput("L").setCheck("Number").appendField("L");
                this.appendValueInput("R").setCheck("Number").appendField("R");
                this.setPreviousStatement(true); this.setNextStatement(true); this.setColour(230); 
            } 
        };
        javascript.javascriptGenerator.forBlock['robot_move'] = function(b) {
            var l = javascript.javascriptGenerator.valueToCode(b, 'L', javascript.Order.ATOMIC) || '0';
            var r = javascript.javascriptGenerator.valueToCode(b, 'R', javascript.Order.ATOMIC) || '0';
            return `
            ${checkStop()}
            var appliedL = ${l} * (typeof _blocklySpeedMultiplier !== 'undefined' ? _blocklySpeedMultiplier : 1.0);
            var appliedR = ${r} * (typeof _blocklySpeedMultiplier !== 'undefined' ? _blocklySpeedMultiplier : 1.0);
            recordMove(appliedL, appliedR, appliedL, appliedR); 
            await sendDrivePacket(appliedL, appliedR, appliedL, appliedR);\n`;
        };
        
        // SOFT START BLOCK
        Blockly.Blocks['robot_move_soft'] = {
            init: function() {
                this.appendDummyInput().appendField("üöÄ –ü–ª–∞–≤–Ω–∏–π —Å—Ç–∞—Ä—Ç –¥–æ");
                this.appendValueInput("TARGET").setCheck("Number");
                this.appendValueInput("SEC").setCheck("Number").appendField("–∑–∞ (—Å–µ–∫)");
                this.setInputsInline(true);
                this.setPreviousStatement(true);
                this.setNextStatement(true);
                this.setColour(230);
                this.setInputsInline(true);
            }
        };
        javascript.javascriptGenerator.forBlock['robot_move_soft'] = function(block) {
            var target = javascript.javascriptGenerator.valueToCode(block, 'TARGET', javascript.Order.ATOMIC) || '100';
            var sec = javascript.javascriptGenerator.valueToCode(block, 'SEC', javascript.Order.ATOMIC) || '1';
            return `
            ${checkStop()}
            var steps = ${sec} * 20; // 20 steps per sec (50ms)
            for(var i=1; i<=steps; i++) {
                ${checkStop()}
                var current = (${target} / steps) * i;
                var applied = current * (typeof _blocklySpeedMultiplier !== 'undefined' ? _blocklySpeedMultiplier : 1.0);
                await sendDrivePacket(applied, applied, applied, applied);
                await new Promise(r => setTimeout(r, 50));
            }
            \n`;
        };

        Blockly.Blocks['move_4_motors'] = { 
            init: function() { 
                this.appendDummyInput().appendField("üöô 4 –ú–æ—Ç–æ—Ä–∏ (ABCD)");
                this.appendValueInput("M1").setCheck("Number").appendField("A:");
                this.appendValueInput("M2").setCheck("Number").appendField("B:");
                this.appendValueInput("M3").setCheck("Number").appendField("C:");
                this.appendValueInput("M4").setCheck("Number").appendField("D:");
                this.setPreviousStatement(true); 
                this.setNextStatement(true); 
                this.setColour(260); 
            } 
        };
        javascript.javascriptGenerator.forBlock['move_4_motors'] = function(block) {
            var m1 = javascript.javascriptGenerator.valueToCode(block, 'M1', javascript.Order.ATOMIC) || '0';
            var m2 = javascript.javascriptGenerator.valueToCode(block, 'M2', javascript.Order.ATOMIC) || '0';
            var m3 = javascript.javascriptGenerator.valueToCode(block, 'M3', javascript.Order.ATOMIC) || '0';
            var m4 = javascript.javascriptGenerator.valueToCode(block, 'M4', javascript.Order.ATOMIC) || '0';
            return `
            ${checkStop()}
            await sendDrivePacket(${m1}, ${m2}, ${m3}, ${m4});\n`;
        };

        Blockly.Blocks['motor_single'] = { 
            init: function() { 
                this.appendDummyInput()
                    .appendField("‚öôÔ∏è –ú–æ—Ç–æ—Ä")
                    .appendField(new Blockly.FieldDropdown([["A","1"], ["B","2"], ["C","3"], ["D","4"]]), "MOTOR")
                    .appendField("–®–≤:");
                this.appendValueInput("SPEED").setCheck("Number");
                this.setPreviousStatement(true); 
                this.setNextStatement(true); 
                this.setColour(260); 
            } 
        };
        javascript.javascriptGenerator.forBlock['motor_single'] = function(block) {
            var m = block.getFieldValue('MOTOR'); 
            var s = javascript.javascriptGenerator.valueToCode(block, 'SPEED', javascript.Order.ATOMIC) || '0';
            return `
            ${checkStop()}
            var current = window.motorState || {m1:0, m2:0, m3:0, m4:0};
            var m1 = current.m1, m2 = current.m2, m3 = current.m3, m4 = current.m4;
            if('${m}' == '1') m1 = ${s};
            if('${m}' == '2') m2 = ${s};
            if('${m}' == '3') m3 = ${s};
            if('${m}' == '4') m4 = ${s};
            await sendDrivePacket(m1, m2, m3, m4);
            \n`;
        };

        Blockly.Blocks['robot_stop'] = { init: function() { this.appendDummyInput().appendField("üõë –°—Ç–æ–ø"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour(0); } };
        javascript.javascriptGenerator.forBlock['robot_stop'] = function() { return `recordMove(0,0,0,0); await sendDrivePacket(0,0,0,0);\n`; };

        Blockly.Blocks['wait_seconds'] = { 
            init: function() { 
                this.appendDummyInput().appendField("‚è≥ –ß–µ–∫–∞—Ç–∏");
                this.appendValueInput("SECONDS").setCheck("Number");
                this.appendDummyInput().appendField("—Å–µ–∫");
                this.setPreviousStatement(true); 
                this.setNextStatement(true); 
                this.setColour(40); 
            } 
        };
        javascript.javascriptGenerator.forBlock['wait_seconds'] = function(b) { 
            var s = javascript.javascriptGenerator.valueToCode(b, 'SECONDS', javascript.Order.ATOMIC) || '0';
            return `
            ${checkStop()}
            recordWait(${s}); 
            await new Promise(r => setTimeout(r, ${s} * 1000));
            ${checkStop()}
            \n`; 
        };

        Blockly.Blocks['sensor_get'] = { 
            init: function() { 
                this.appendDummyInput()
                    .appendField(new Blockly.FieldDropdown([["üìè –í—ñ–¥—Å—Ç–∞–Ω—å", "DIST"], ["üí° –°–≤—ñ—Ç–ª–æ", "LIGHT"], ["üëÜ –î–æ—Ç–∏–∫", "TOUCH"]]), "TYPE")
                    .appendField("–ü–æ—Ä—Ç")
                    .appendField(new Blockly.FieldDropdown([["1","0"], ["2","1"], ["3","2"], ["4","3"]]), "SENS");
                this.setOutput(true, "Number"); 
                this.setColour(180); 
            } 
        };
        javascript.javascriptGenerator.forBlock['sensor_get'] = function(b) { 
            var idx = b.getFieldValue('SENS');
            return [`(window.sensorData ? window.sensorData[${idx}] : 0)`, javascript.Order.ATOMIC]; 
        };
        
        Blockly.Blocks['go_home'] = { init: function() { this.appendDummyInput().appendField("üè† –î–æ–¥–æ–º—É (–ù–∞–∑–∞–¥)"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour(230); } }; 
        javascript.javascriptGenerator.forBlock['go_home'] = function() { return 'await goHomeSequence();\n'; };

        let moveHistory = [];
        let isCodeRunning = false;
        window._shouldStop = false;
        
        window._trackMemory = [];
        window._isRecordingTrack = false;

        function recordMove(m1, m2, m3, m4) { if(isCodeRunning) moveHistory.push({ type: 'move', m1: parseInt(m1), m2: parseInt(m2), m3: parseInt(m3), m4: parseInt(m4) }); }
        function recordWait(sec) { if(isCodeRunning) moveHistory.push({ type: 'wait', sec: parseFloat(sec) }); }

        async function goHomeSequence() {
            for (let i = moveHistory.length - 1; i >= 0; i--) {
                if(window._shouldStop) return;
                const action = moveHistory[i];
                if (action.type === 'wait') await new Promise(r => setTimeout(r, action.sec * 1000));
                else if (action.type === 'move') await sendDrivePacket(-action.m1, -action.m2, -action.m3, -action.m4);
            }
            await sendDrivePacket(0, 0, 0, 0); moveHistory = [];
        }

        var _pidIntegral = 0;
        var _pidLastError = 0;
        window.calculatePID = function(error, kp, ki, kd) {
            var p = error * kp;
            _pidIntegral += error;
            var i = _pidIntegral * ki;
            var d = (error - _pidLastError) * kd;
            _pidLastError = error;
            return p + i + d;
        };

        window.blockStates = {}; 

        window.checkRisingEdge = function(id, currentVal) {
            let boolVal = currentVal === true || (typeof currentVal === 'number' && currentVal > 0);
            let lastVal = window.blockStates[id] || false;
            window.blockStates[id] = boolVal; 
            return boolVal && !lastVal; 
        };

        window.schmittTrigger = function(id, val, low, high) {
            let state = window.blockStates[id] || false; 
            if (val >= high) state = true;
            else if (val <= low) state = false;
            window.blockStates[id] = state;
            return state;
        };

        window.smoothValue = function(id, val, size) {
            let buffer = window.blockStates[id] || [];
            if(!Array.isArray(buffer)) buffer = [];
            
            buffer.push(val);
            if (buffer.length > size) buffer.shift(); 
            
            window.blockStates[id] = buffer;
            
            let sum = buffer.reduce((a, b) => a + b, 0);
            return sum / buffer.length;
        };

        window.toggleRunState = function() { 
            if(isCodeRunning) stopCode(); else runCode(); 
        };
        
        window.runCode = async function() {
            if(!isConnected) { 
                alert("–°–ø–æ—á–∞—Ç–∫—É –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –¥–æ Bluetooth!"); return;
            }
            
            isCodeRunning = true; 
            window._shouldStop = false; 
            moveHistory = [];
            
            _pidIntegral = 0;
            _pidLastError = 0;
            window.blockStates = {}; 
            window._trackMemory = []; 

            const btn = document.getElementById('globalRunBtn');
            const icon = document.getElementById('runIcon');
            btn.classList.add('running'); 
            icon.classList.remove('fa-play'); 
            icon.classList.add('fa-stop');
            
            log("Program Started");

            javascript.javascriptGenerator.STATEMENT_PREFIX = 'if (window._shouldStop) throw "STOPPED";\n';
            
            let code = "var _startTime = new Date().getTime(); var _blocklySpeedMultiplier = 1.0; var x; " + javascript.javascriptGenerator.workspaceToCode(workspace);
            
            try { 
                const runner = new Function(`return (async () => { ${code} })();`); 
                await runner(); 
            } catch(e) { 
                if (e === "STOPPED") {
                    console.log("Program stopped by user.");
                    log("Program Stopped by User", "warn");
                } else {
                    console.error(e); 
                    log("Runtime Error: " + e, "error");
                }
            } 
            finally { 
                stopCode(); 
            }
        };
        
        window.stopCode = function() { 
            window._shouldStop = true;
            isCodeRunning = false;
            window._isRecordingTrack = false;
            sendDrivePacket(0,0,0,0);
            
            const btn = document.getElementById('globalRunBtn');
            const icon = document.getElementById('runIcon');
            btn.classList.remove('running'); 
            icon.classList.remove('fa-stop'); 
            icon.classList.add('fa-play');
        };
        
        function loadExample(type) {
             const xmlAutopilot = '<xml xmlns="https://developers.google.com/blockly/xml"><block type="start_hat" id="start" x="50" y="50"><next><block type="controls_whileUntil" id="loop"><field name="MODE">WHILE</field><value name="BOOL"><block type="logic_boolean"><field name="BOOL">TRUE</field></block></value><statement name="DO"><block type="controls_if"><mutation else="1"></mutation><value name="IF0"><block type="wait_until_sensor"><field name="SENS">0</field><field name="OP">LT</field><value name="VAL"><shadow type="math_number"><field name="NUM">25</field></shadow></value></block></value><statement name="DO0"><block type="robot_stop"><next><block type="robot_turn_timed"><field name="DIR">RIGHT</field><value name="SEC"><shadow type="math_number"><field name="NUM">0.5</field></shadow></value></block></next></block></statement><statement name="ELSE"><block type="robot_move"><value name="L"><shadow type="math_number"><field name="NUM">80</field></shadow></value><value name="R"><shadow type="math_number"><field name="NUM">80</field></shadow></value></block></statement></block></statement></block></next></block></xml>';
             
             const xmlSquare = '<xml xmlns="https://developers.google.com/blockly/xml"><block type="start_hat" id="start" x="50" y="50"><next><block type="controls_repeat_ext"><value name="TIMES"><shadow type="math_number"><field name="NUM">4</field></shadow></value><statement name="DO"><block type="robot_move"><value name="L"><shadow type="math_number"><field name="NUM">100</field></shadow></value><value name="R"><shadow type="math_number"><field name="NUM">100</field></shadow></value><next><block type="wait_seconds"><value name="SECONDS"><shadow type="math_number"><field name="NUM">1</field></shadow></value><next><block type="robot_turn_timed"><field name="DIR">RIGHT</field><value name="SEC"><shadow type="math_number"><field name="NUM">0.6</field></shadow></value></block></next></block></next></block></statement><next><block type="robot_stop"></block></next></block></next></block></xml>';

             const xmlLine = '<xml xmlns="https://developers.google.com/blockly/xml"><block type="start_hat" x="50" y="50"><next><block type="controls_whileUntil"><field name="MODE">WHILE</field><value name="BOOL"><block type="logic_boolean"><field name="BOOL">TRUE</field></block></value><statement name="DO"><block type="controls_if"><mutation else="1"></mutation><value name="IF0"><block type="logic_compare"><field name="OP">LT</field><value name="A"><block type="sensor_get"><field name="TYPE">LIGHT</field><field name="SENS">1</field></block></value><value name="B"><block type="math_number"><field name="NUM">50</field></block></value></block></value><statement name="DO0"><block type="robot_move"><value name="L"><shadow type="math_number"><field name="NUM">30</field></shadow></value><value name="R"><shadow type="math_number"><field name="NUM">80</field></shadow></value></block></statement><statement name="ELSE"><block type="robot_move"><value name="L"><shadow type="math_number"><field name="NUM">80</field></shadow></value><value name="R"><shadow type="math_number"><field name="NUM">30</field></shadow></value></block></statement></block></statement></block></next></block></xml>';

             let xmlStr = "";
             if(type === 'autopilot') xmlStr = xmlAutopilot;
             if(type === 'square') xmlStr = xmlSquare;
             if(type === 'line_follow') xmlStr = xmlLine;

             if(xmlStr) {
                 workspace.clear();
                 Blockly.Xml.domToWorkspace(Blockly.utils.xml.textToDom(xmlStr), workspace);
                 document.getElementById('exampleModal').classList.add('hidden');
                 log("Loaded example: " + type, 'info');
             }
        }

        function newProject() {
            if(confirm("–°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π –ø—Ä–æ–µ–∫—Ç? –ü–æ—Ç–æ—á–Ω—ñ –±–ª–æ–∫–∏ –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ.")) {
                workspace.clear();
                const xmlStr = '<xml xmlns="https://developers.google.com/blockly/xml"><block type="start_hat" x="50" y="50"></block></xml>';
                Blockly.Xml.domToWorkspace(Blockly.utils.xml.textToDom(xmlStr), workspace);
                document.getElementById('exampleModal').classList.add('hidden');
                log("–°—Ç–≤–æ—Ä–µ–Ω–æ –Ω–æ–≤–∏–π –ø—Ä–æ–µ–∫—Ç", "info");
            }
        }

        function saveMyFile() {
            try {
                const xmlDom = Blockly.Xml.workspaceToDom(workspace);
                const xmlText = Blockly.utils.xml.domToText(xmlDom);
                
                let fileName = prompt("–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É –¥–ª—è —Ñ–∞–π–ª—É:", "robot_code");
                if (fileName === null) return; 
                if (!fileName) fileName = "robot_block_code"; 
                if (!fileName.toLowerCase().endsWith(".xml")) fileName += ".xml";

                const blob = new Blob([xmlText], {type: "text/xml"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                document.getElementById('exampleModal').classList.add('hidden');
                log("–§–∞–π–ª –∑–±–µ—Ä–µ–∂–µ–Ω–æ: " + fileName, "info");
            } catch(e) {
                console.error(e);
            }
        }

        function loadMyFile(input, isAppend) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const xmlText = e.target.result;
                try {
                    if (!isAppend) {
                        workspace.clear();
                    }
                    const xmlDom = Blockly.utils.xml.textToDom(xmlText);
                    Blockly.Xml.domToWorkspace(xmlDom, workspace);
                    document.getElementById('exampleModal').classList.add('hidden');
                    log(isAppend ? "–§–∞–π–ª –¥–æ–¥–∞–Ω–æ!" : "–§–∞–π–ª –≤—ñ–¥–∫—Ä–∏—Ç–æ!", "info");
                } catch(err) {
                    alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —Ñ–∞–π–ª—É. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ —Ü–µ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π XML.");
                    log("Load Error: " + err, "err");
                }
            };
            reader.readAsText(file);
            input.value = ''; 
        }

        Blockly.dialog.setPrompt(function(message, defaultValue, callback) {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-4 backdrop-blur-sm';
            
            const modal = document.createElement('div');
            modal.className = 'bg-slate-900 w-full max-w-sm rounded-2xl border border-slate-700 p-6 shadow-2xl';
            
            const title = document.createElement('h3');
            title.className = 'text-lg font-bold text-white mb-4 text-center';
            title.innerText = message;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-white focus:border-blue-500 outline-none mb-4';
            input.value = defaultValue;
            
            const btnContainer = document.createElement('div');
            btnContainer.className = 'grid grid-cols-2 gap-3';
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'py-2 rounded-xl bg-slate-800 text-slate-400 hover:bg-slate-700 font-bold';
            cancelBtn.innerText = '–°–∫–∞—Å—É–≤–∞—Ç–∏';
            cancelBtn.onclick = () => { document.body.removeChild(overlay); callback(null); };
            
            const okBtn = document.createElement('button');
            okBtn.className = 'py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-500 font-bold';
            okBtn.innerText = 'OK';
            okBtn.onclick = () => { document.body.removeChild(overlay); callback(input.value); };
            
            btnContainer.appendChild(cancelBtn);
            btnContainer.appendChild(okBtn);
            modal.appendChild(title);
            modal.appendChild(input);
            modal.appendChild(btnContainer);
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
            input.focus();
        });
        
        setTimeout(() => {
             if (workspace) { workspace.createVariable('x'); }
        }, 1000);

        window.sendDrivePacket = sendDrivePacket;
        window.log = log;
    </script>
</body>
</html>
