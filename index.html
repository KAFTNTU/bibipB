<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RoboControl Car</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>

    <style>
        body {
            overscroll-behavior: none;
            touch-action: none;
            user-select: none;
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: #0f172a;
            color: white;
            overflow: hidden; 
        }
        
        .glass-header {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        /* --- –î–∂–æ–π—Å—Ç–∏–∫ --- */
        #joystick-container { position: relative; width: 280px; height: 280px; margin: 0 auto; }
        #joystick-base {
            width: 100%; height: 100%;
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 70%);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.6), inset 0 0 20px rgba(0, 0, 0, 0.8);
            position: relative;
        }
        #joystick-stick {
            position: absolute; width: 90px; height: 90px;
            background: radial-gradient(circle at 30% 30%, #3b82f6, #1d4ed8);
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 8px 20px rgba(0,0,0,0.7);
            cursor: grab; z-index: 10;
            transition: transform 0.1s;
        }
        #joystick-stick.snap-back { transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #joystick-stick::after {
            content: ''; position: absolute; top: 20px; left: 20px; width: 25px; height: 25px;
            background: rgba(255,255,255,0.2); border-radius: 50%;
        }

        .lock-btn { transition: all 0.3s; }
        .lock-active { background-color: #ef4444 !important; box-shadow: 0 0 10px #ef4444; color: white !important; border-color: #ef4444 !important; }

        /* --- –°–ª–∞–π–¥–µ—Ä —à–≤–∏–¥–∫–æ—Å—Ç—ñ --- */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
            background: #3b82f6; cursor: pointer; margin-top: -8px; box-shadow: 0 0 10px rgba(59,130,246,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px;
        }

        /* --- Blockly Customization --- */
        #blocklyDiv { height: 100%; width: 100%; }
        
        .blocklySvg { background-color: transparent !important; }
        
        /* –¢–µ–º–Ω–∞ —Ç–µ–º–∞ –º–µ–Ω—é (Toolbox) */
        .blocklyToolboxDiv { 
            background-color: #020617 !important; /* Very Dark Slate */
            border-right: 1px solid #1e293b;
            box-shadow: 5px 0 20px rgba(0,0,0,0.5);
            /* –í–∞–∂–ª–∏–≤–æ –¥–ª—è —Ä–µ—Å–∞–π–∑—É */
            min-width: 120px; 
            max-width: 80vw;
        }
        
        /* –°—Ç–∏–ª—å –∫–∞—Ç–µ–≥–æ—Ä—ñ–π */
        .blocklyTreeLabel { color: #94a3b8 !important; font-family: 'Segoe UI', sans-serif; font-weight: 500; }
        .blocklyTreeRow:hover { background-color: #1e293b !important; }
        .blocklyTreeSelected .blocklyTreeRow { 
            background-color: #2563eb !important; /* Blue 600 */
            border-left: 3px solid #60a5fa;
        }
        
        /* –§–æ–Ω –º–µ–Ω—é –≤–∏–±–æ—Ä—É (Flyout) */
        .blocklyFlyoutBackground { fill: #0f172a !important; fill-opacity: 0.95; }

        /* –ü—Ä–∏—Ö–æ–≤–∞–Ω–Ω—è —Å–∫—Ä–æ–ª–±–∞—Ä—ñ–≤ */
        .blocklyScrollbarHandle, .blocklyScrollbarBackground {
            display: none !important; opacity: 0 !important; visibility: hidden !important;
        }

        /* RESIZE HANDLE */
        #toolbox-resize-handle {
            position: absolute;
            top: 0; right: 0; bottom: 0;
            width: 6px;
            cursor: col-resize;
            background: transparent;
            transition: background 0.2s;
            z-index: 999;
        }
        #toolbox-resize-handle:hover, #toolbox-resize-handle.dragging {
            background: #3b82f6; /* Blue on hover/drag */
        }

        #floatingControls {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform: scale(0);
        }
        #floatingControls.visible { transform: scale(1); }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ef4444; display: inline-block; transition: all 0.3s;}
        .connected { background: #22c55e; box-shadow: 0 0 8px #22c55e; }

        .nav-btn { color: #64748b; padding: 8px 12px; border-radius: 8px; transition: all 0.2s; }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: #94a3b8; }
        .nav-btn.active { color: #3b82f6; background: rgba(59, 130, 246, 0.1); }

        .log-line { font-family: 'Courier New', monospace; font-size: 11px; padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .log-tx { color: #60a5fa; } .log-rx { color: #34d399; } .log-err { color: #f87171; }
        
        .key-hint { 
            display: inline-block; padding: 2px 6px; background: #334155; 
            border-radius: 4px; font-family: monospace; font-size: 10px; color: #94a3b8; border-bottom: 2px solid #1e293b;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col">

    <!-- === HEADER === -->
    <header class="h-16 glass-header flex items-center justify-between px-4 z-20 absolute top-0 w-full">
        <div class="flex items-center gap-2">
            <span id="statusDot" class="status-dot"></span>
            <span id="statusText" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest hidden sm:block">OFFLINE</span>
        </div>
        
        <nav class="flex items-center gap-1 bg-slate-800/50 p-1 rounded-xl border border-slate-700/50">
            <button onclick="switchView('view-joystick', this)" class="nav-btn active" title="–ü—É–ª—å—Ç">
                <i class="fa-solid fa-gamepad text-lg"></i>
            </button>
            <button onclick="switchView('view-builder', this)" class="nav-btn" title="–ë–ª–æ–∫–∏">
                <i class="fa-solid fa-puzzle-piece text-lg"></i>
            </button>
            <div class="w-px h-6 bg-slate-700 mx-1"></div>
            <button onclick="openPassModal()" class="nav-btn text-emerald-500/80 hover:text-emerald-400" title="–ü–∞—Ä–æ–ª—å">
                <i class="fa-solid fa-lock text-lg"></i>
            </button>
            <button onclick="toggleLogModal()" class="nav-btn text-yellow-500/80 hover:text-yellow-400" title="–õ–æ–≥">
                <i class="fa-solid fa-book text-lg"></i>
            </button>
        </nav>
        
        <button id="btConnect" class="w-10 h-10 rounded-full bg-blue-600 active:bg-blue-700 hover:bg-blue-500 text-white shadow-lg flex items-center justify-center transition-all border border-blue-400/30">
            <i class="fa-brands fa-bluetooth-b text-lg"></i>
        </button>
    </header>

    <!-- === MAIN CONTENT === -->
    <main class="flex-1 relative overflow-hidden bg-gradient-to-br from-slate-900 to-slate-950 pt-16">
        
        <!-- --- VIEW 1: JOYSTICK --- -->
        <section id="view-joystick" class="absolute inset-0 flex flex-col items-center justify-center p-4 transition-opacity duration-300">
            
            <!-- Joystick -->
            <div id="joystick-container" class="mb-2">
                <div id="joystick-base">
                    <div id="joystick-stick" class="snap-back"></div>
                </div>
            </div>
            
            <!-- Keyboard Hint -->
            <div class="text-center mb-4 opacity-50 hidden md:block">
                <span class="key-hint">W</span> <span class="key-hint">A</span> <span class="key-hint">S</span> <span class="key-hint">D</span> –¥–ª—è —Ä—É—Ö—É
            </div>

            <!-- Controls Cluster -->
            <div class="w-full max-w-xs flex flex-col gap-3 bg-slate-800/40 p-4 rounded-2xl border border-slate-700/30 backdrop-blur-sm">
                
                <!-- Monitors -->
                <div class="flex items-center justify-between gap-4">
                    <div class="bg-slate-900 px-3 py-1.5 rounded-lg border border-slate-700 text-center flex-1">
                        <span class="text-[10px] text-green-500 font-bold mr-1">L</span>
                        <span id="motorLDisplay" class="text-blue-400 font-mono font-bold">0</span>
                    </div>
                    
                    <button id="lockJoyBtn" class="lock-btn w-10 h-10 rounded-full bg-slate-700 text-slate-400 flex items-center justify-center shadow-md border border-slate-600 hover:bg-slate-600 active:scale-95" onclick="toggleLock()" title="–ó–∞—Ñ—ñ–∫—Å—É–≤–∞—Ç–∏ –≥–∞–∑">
                        <i class="fa-solid fa-anchor text-sm"></i>
                    </button>

                    <div class="bg-slate-900 px-3 py-1.5 rounded-lg border border-slate-700 text-center flex-1">
                        <span class="text-[10px] text-green-500 font-bold mr-1">R</span>
                        <span id="motorRDisplay" class="text-blue-400 font-mono font-bold">0</span>
                    </div>
                </div>

                <!-- Speed Slider -->
                <div class="pt-2 border-t border-white/5">
                    <div class="flex justify-between text-[10px] text-slate-400 mb-1 uppercase tracking-wide">
                        <span>–ü–æ—Ç—É–∂–Ω—ñ—Å—Ç—å</span>
                        <span id="speedVal">100%</span>
                    </div>
                    <input type="range" id="speedSlider" min="10" max="100" value="100" step="10">
                </div>

                <!-- HEX Display -->
                <div class="bg-black/40 px-3 py-1 rounded text-[10px] font-mono tracking-widest text-slate-400 border border-slate-800/50 text-center">
                    HEX: <span id="joyHex" class="text-yellow-500 font-bold">00 00 0A</span>
                </div>
            </div>
        </section>


        <!-- --- VIEW 2: BUILDER --- -->
        <section id="view-builder" class="absolute inset-0 flex flex-col hidden opacity-0 transition-opacity duration-300">
            
            <div class="h-10 bg-slate-800/90 mt-2 mx-2 rounded-lg flex items-center justify-between px-4 border border-slate-700 z-10 shadow-lg">
                <span class="text-xs text-slate-400 font-bold"><i class="fa-solid fa-eye mr-2"></i>–î–ê–¢–ß–ò–ö (S):</span>
                <span id="sensorValDisplay" class="font-mono text-emerald-400 font-bold text-lg">--</span>
            </div>

            <!-- Blockly Div -->
            <div id="blocklyDiv" class="flex-1 mt-0"></div>

            <div id="floatingControls" class="absolute bottom-6 right-6 flex gap-3 z-20 origin-bottom-right">
                <button onclick="stopCode()" class="w-14 h-14 rounded-full bg-red-600 hover:bg-red-500 text-white shadow-xl shadow-red-900/40 flex items-center justify-center border-2 border-red-400 transition-transform hover:scale-105 active:scale-95" title="–°—Ç–æ–ø">
                    <i class="fa-solid fa-stop text-xl"></i>
                </button>
                <button onclick="runCode()" class="w-16 h-16 rounded-full bg-emerald-500 hover:bg-emerald-400 text-white shadow-xl shadow-emerald-900/40 flex items-center justify-center border-4 border-emerald-300 animate-pulse-slow transition-transform hover:scale-105 active:scale-95" title="–ó–∞–ø—É—Å–∫">
                    <i class="fa-solid fa-play text-2xl pl-1"></i>
                </button>
            </div>
        </section>
    </main>


    <!-- === MODALS === -->
    <div id="passModal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center backdrop-blur-md p-4">
        <div class="bg-slate-900 p-6 rounded-2xl w-full max-w-sm shadow-2xl border border-slate-700">
            <h3 class="text-lg font-bold text-white mb-6 text-center tracking-wide">–î–û–°–¢–£–ü</h3>
            <div class="relative mb-6">
                <i class="fa-solid fa-key absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
                <input type="text" id="passInput" class="w-full bg-slate-950 border border-slate-700 rounded-xl pl-10 pr-4 py-4 text-white focus:border-blue-500 outline-none text-center text-xl tracking-[0.5em] font-mono" placeholder="****">
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closePassModal()" class="py-3 rounded-xl bg-slate-800 text-slate-400 hover:bg-slate-700">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                <button onclick="sendPassword()" class="py-3 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-500 shadow-lg shadow-blue-900/50">OK</button>
            </div>
        </div>
    </div>

    <div id="logModal" class="fixed inset-0 bg-black/50 z-40 hidden flex items-end sm:items-center justify-center backdrop-blur-sm sm:p-4">
        <div class="bg-slate-900 w-full sm:max-w-md h-2/3 sm:h-[500px] sm:rounded-2xl rounded-t-2xl shadow-2xl border border-slate-700 flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-slate-800">
                <h3 class="text-sm font-bold text-yellow-500 flex items-center gap-2"><i class="fa-solid fa-book"></i> –°–ò–°–¢–ï–ú–ù–ò–ô –õ–û–ì</h3>
                <div class="flex gap-2">
                    <button onclick="clearLog()" class="text-slate-500 hover:text-white text-xs px-2"><i class="fa-solid fa-trash"></i></button>
                    <button onclick="toggleLogModal()" class="text-slate-500 hover:text-white text-lg"><i class="fa-solid fa-xmark"></i></button>
                </div>
            </div>
            <div id="logContainer" class="flex-1 overflow-y-auto p-4 space-y-1 bg-black/20 font-mono text-xs">
                <div class="text-slate-500 italic">-- –ñ—É—Ä–Ω–∞–ª –ø–æ–¥—ñ–π --</div>
            </div>
        </div>
    </div>

    <!-- XML Blocks -->
    <xml id="toolbox" style="display: none">
        <category name="üåü –ì–æ—Ç–æ–≤—ñ –∑–±—ñ—Ä–∫–∏" colour="#fbbf24">
            <block type="controls_repeat_ext">
                <value name="TIMES"><shadow type="math_number"><field name="NUM">4</field></shadow></value>
                <statement name="DO">
                    <block type="robot_move">
                        <value name="L"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
                        <value name="R"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
                        <next>
                            <block type="wait_seconds">
                                <field name="SECONDS">1</field>
                                <next>
                                    <block type="robot_move">
                                        <value name="L"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
                                        <value name="R"><shadow type="math_number"><field name="NUM">-100</field></shadow></value>
                                        <next>
                                            <block type="wait_seconds">
                                                <field name="SECONDS">0.5</field>
                                            </block>
                                        </next>
                                    </block>
                                </next>
                            </block>
                        </next>
                    </block>
                </statement>
            </block>
            <block type="controls_repeat_ext">
                <value name="TIMES"><shadow type="math_number"><field name="NUM">3</field></shadow></value>
                <statement name="DO">
                    <block type="robot_move">
                        <value name="L"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
                        <value name="R"><shadow type="math_number"><field name="NUM">-100</field></shadow></value>
                        <next>
                            <block type="wait_seconds">
                                <field name="SECONDS">0.5</field>
                                <next>
                                    <block type="robot_move">
                                        <value name="L"><shadow type="math_number"><field name="NUM">-100</field></shadow></value>
                                        <value name="R"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
                                        <next>
                                            <block type="wait_seconds">
                                                <field name="SECONDS">0.5</field>
                                            </block>
                                        </next>
                                    </block>
                                </next>
                            </block>
                        </next>
                    </block>
                </statement>
            </block>
        </category>
        <category name="–ú–∞—à–∏–Ω–∫–∞" colour="#4C97FF">
            <block type="robot_move">
                <value name="L"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
                <value name="R"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
            </block>
            <block type="robot_stop"></block>
        </category>
        <category name="–õ–æ–≥—ñ–∫–∞" colour="%{BKY_LOGIC_HUE}">
            <block type="controls_if"></block>
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
        </category>
        <category name="–¶–∏–∫–ª–∏" colour="%{BKY_LOOPS_HUE}">
            <block type="controls_repeat_ext"><value name="TIMES"><shadow type="math_number"><field name="NUM">10</field></shadow></value></block>
            <block type="controls_whileUntil"></block>
        </category>
        <category name="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞" colour="%{BKY_MATH_HUE}">
            <block type="math_number"></block>
            <block type="math_random_int"></block>
            <block type="sensor_get"></block>
        </category>
        <category name="–ß–∞—Å" colour="#FFBF00">
            <block type="wait_seconds"><field name="SECONDS">1</field></block>
        </category>
    </xml>

    <script>
        // === GLOBAL STATE ===
        let isConnected = false;
        let device, characteristic;
        let isLocked = false;
        let activeView = 'view-joystick';
        
        let currentL = 0;
        let currentR = 0;
        let speedMultiplier = 1.0; // 100%
        
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const btnConnect = document.getElementById('btConnect');
        const motorLDisplay = document.getElementById('motorLDisplay');
        const motorRDisplay = document.getElementById('motorRDisplay');
        const joyHex = document.getElementById('joyHex');
        const speedSlider = document.getElementById('speedSlider');
        const speedVal = document.getElementById('speedVal');

        // === HEARTBEAT ===
        setInterval(() => {
            if (isConnected) {
                sendMoveData(currentL, currentR);
            }
        }, 100);

        // === LOGGING ===
        function log(msg, type = 'info') {
            const container = document.getElementById('logContainer');
            const el = document.createElement('div');
            el.classList.add('log-line');
            const time = new Date().toLocaleTimeString().split(' ')[0];
            let prefix = '';
            if(type === 'tx') { el.classList.add('log-tx'); prefix = 'TX -> '; }
            else if(type === 'rx') { el.classList.add('log-rx'); prefix = 'RX <- '; }
            else if(type === 'err') { el.classList.add('log-err'); prefix = 'ERR ! '; }
            else { el.classList.add('text-slate-400'); prefix = 'SYS : '; }
            el.innerText = `[${time}] ${prefix}${msg}`;
            container.appendChild(el);
            container.scrollTop = container.scrollHeight;
        }
        function clearLog() { document.getElementById('logContainer').innerHTML = '<div class="text-slate-500 italic">-- –õ–æ–≥ –æ—á–∏—â–µ–Ω–æ --</div>'; }
        function toggleLogModal() { document.getElementById('logModal').classList.toggle('hidden'); }

        // === SPEED SLIDER LOGIC ===
        speedSlider.addEventListener('input', (e) => {
            const val = e.target.value;
            speedVal.innerText = val + '%';
            speedMultiplier = val / 100;
        });

        // === KEYBOARD CONTROL (WASD) ===
        const keys = { w: false, a: false, s: false, d: false };
        
        document.addEventListener('keydown', (e) => {
            if(activeView !== 'view-joystick') return;
            const key = e.key.toLowerCase();
            if(keys.hasOwnProperty(key)) {
                keys[key] = true;
                updateKeyboardLogic();
            }
        });

        document.addEventListener('keyup', (e) => {
            if(activeView !== 'view-joystick') return;
            const key = e.key.toLowerCase();
            if(keys.hasOwnProperty(key)) {
                keys[key] = false;
                updateKeyboardLogic();
            }
        });

        function updateKeyboardLogic() {
            let x = 0; 
            let y = 0;
            if (keys.w) y = 100;
            if (keys.s) y = -100;
            if (keys.a) x = -100;
            if (keys.d) x = 100;
            if (y !== 0 && x !== 0) x = x * 0.5;
            updateTankLogic(x, y);
        }

        // === NAVIGATION ===
        function switchView(viewId, btnElement) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');
            document.getElementById('view-joystick').classList.add('hidden', 'opacity-0');
            document.getElementById('view-builder').classList.add('hidden', 'opacity-0');
            const target = document.getElementById(viewId);
            target.classList.remove('hidden');
            setTimeout(() => target.classList.remove('opacity-0'), 10);
            activeView = viewId;
            if(viewId === 'view-builder') {
                setTimeout(() => Blockly.svgResize(workspace), 100);
            }
        }

        // Modal Logic
        function openPassModal() { document.getElementById('passModal').classList.remove('hidden'); }
        function closePassModal() { document.getElementById('passModal').classList.add('hidden'); }
        function sendPassword() {
            const pass = document.getElementById('passInput').value;
            if (pass) {
                sendTextData(`PASS:${pass}`);
                log(`Password sent: ****`, 'tx');
                document.getElementById('passInput').value = '';
                closePassModal();
            }
        }

        // === JOYSTICK LOGIC ===
        const stick = document.getElementById('joystick-stick');
        const base = document.getElementById('joystick-base');
        const lockBtn = document.getElementById('lockJoyBtn');
        let dragging = false;
        let joyCenter = { x: 0, y: 0 };
        const maxDist = 90;

        function toggleLock() {
            isLocked = !isLocked;
            if (isLocked) { lockBtn.classList.add('lock-active'); log('Joystick Locked', 'info'); } 
            else { lockBtn.classList.remove('lock-active'); log('Joystick Unlocked', 'info'); resetJoystick(); }
        }

        function startJoy(e) {
            if(activeView !== 'view-joystick') return;
            dragging = true;
            stick.classList.remove('snap-back');
            const rect = base.getBoundingClientRect();
            joyCenter = { x: rect.left + rect.width/2, y: rect.top + rect.height/2 };
        }

        function endJoy() {
            if(activeView !== 'view-joystick') return;
            dragging = false;
            if (!isLocked) resetJoystick();
        }

        function resetJoystick() {
            stick.classList.add('snap-back');
            stick.style.transform = `translate(-50%, -50%)`;
            updateTankLogic(0, 0);
        }

        function moveJoy(e) {
            if (!dragging) return;
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const dx = clientX - joyCenter.x;
            const dy = clientY - joyCenter.y;
            const dist = Math.min(Math.hypot(dx, dy), maxDist);
            const angle = Math.atan2(dy, dx);
            const moveX = Math.cos(angle) * dist;
            const moveY = Math.sin(angle) * dist;
            stick.style.transform = `translate(-50%, -50%) translate(${moveX}px, ${moveY}px)`;
            
            const valX = Math.round((moveX / maxDist) * 100);
            const valY = Math.round((moveY / maxDist) * 100) * -1;
            updateTankLogic(valX, valY);
        }
        
        function updateTankLogic(valX, valY) {
            let vL = valY + valX;
            let vR = valY - valX;
            vL = Math.max(-100, Math.min(100, vL));
            vR = Math.max(-100, Math.min(100, vR));
            vL = Math.round(vL * speedMultiplier);
            vR = Math.round(vR * speedMultiplier);
            currentL = vL; currentR = vR;
            updateDisplay(vL, vR);
        }

        function updateDisplay(l, r) {
            motorLDisplay.innerText = l;
            motorRDisplay.innerText = r;
            const hL = (l & 0xFF).toString(16).toUpperCase().padStart(2, '0');
            const hR = (r & 0xFF).toString(16).toUpperCase().padStart(2, '0');
            joyHex.innerText = `${hL} ${hR} 0A`;
        }

        base.addEventListener('mousedown', startJoy);
        base.addEventListener('touchstart', startJoy);
        window.addEventListener('mouseup', endJoy);
        window.addEventListener('touchend', endJoy);
        window.addEventListener('mousemove', moveJoy);
        window.addEventListener('touchmove', moveJoy, { passive: false });

        // === BLOCKLY SETUP ===
        Blockly.Blocks['robot_move'] = {
            init: function() {
                this.appendDummyInput().appendField("üöó –ú–∞—à–∏–Ω–∫–∞ –á—Ö–∞—Ç–∏");
                this.appendValueInput("L").setCheck("Number").appendField("–õ—ñ–≤–∏–π");
                this.appendValueInput("R").setCheck("Number").appendField("–ü—Ä–∞–≤–∏–π");
                this.setPreviousStatement(true); this.setNextStatement(true); this.setColour(230);
            }
        };
        javascript.javascriptGenerator.forBlock['robot_move'] = function(block, generator) {
            var l = generator.valueToCode(block, 'L', javascript.Order.ATOMIC) || '0';
            var r = generator.valueToCode(block, 'R', javascript.Order.ATOMIC) || '0';
            return `currentL = ${l}; currentR = ${r};\n`;
        };
        
        Blockly.Blocks['robot_stop'] = { init: function() { this.appendDummyInput().appendField("üõë –°—Ç–æ–ø"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour(0); } };
        javascript.javascriptGenerator.forBlock['robot_stop'] = function(block, generator) { return `currentL = 0; currentR = 0;\n`; };

        Blockly.Blocks['wait_seconds'] = { init: function() { this.appendDummyInput().appendField("‚è≥ –ß–µ–∫–∞—Ç–∏").appendField(new Blockly.FieldNumber(1), "SECONDS"); this.setPreviousStatement(true); this.setNextStatement(true); this.setColour(40); } };
        javascript.javascriptGenerator.forBlock['wait_seconds'] = function(block, generator) { return `await new Promise(r => setTimeout(r, ${block.getFieldValue('SECONDS')*1000}));\n`; };

        Blockly.Blocks['sensor_get'] = { init: function() { this.appendDummyInput().appendField("üëÅÔ∏è –î–∞—Ç—á–∏–∫"); this.setOutput(true, "Number"); this.setColour(180); } };
        javascript.javascriptGenerator.forBlock['sensor_get'] = function(block, generator) { return ['window.sensorVal', javascript.Order.ATOMIC]; };

        var workspace = Blockly.inject('blocklyDiv', {
            toolbox: document.getElementById('toolbox'),
            theme: Blockly.Themes.Dark,
            renderer: 'zelos',
            scrollbars: false,
            move: {
                scrollbars: false,
                drag: true,
                wheel: true
            },
            grid: { spacing: 25, length: 3, colour: '#334155', snap: true },
            zoom: { controls: true, wheel: true, startScale: 1.0, maxScale: 3, minScale: 0.3, scaleSpeed: 1.2 }
        });

        // RESIZABLE TOOLBOX LOGIC
        setTimeout(() => {
            const toolbox = document.querySelector('.blocklyToolboxDiv');
            if (toolbox) {
                const handle = document.createElement('div');
                handle.id = 'toolbox-resize-handle';
                toolbox.appendChild(handle);
                
                let isResizing = false;
                
                handle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    handle.classList.add('dragging');
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;
                    const newWidth = e.clientX;
                    if (newWidth > 100 && newWidth < window.innerWidth * 0.8) {
                        toolbox.style.width = newWidth + 'px';
                    }
                });
                
                document.addEventListener('mouseup', () => {
                    if(isResizing) {
                        isResizing = false;
                        handle.classList.remove('dragging');
                        // Force Blockly to reflow
                        Blockly.svgResize(workspace);
                    }
                });
            }
        }, 500); // Wait for Blockly inject

        workspace.addChangeListener(function(event) {
            const fab = document.getElementById('floatingControls');
            if (workspace.getAllBlocks().length > 0) { fab.classList.add('visible'); } 
            else { fab.classList.remove('visible'); }
        });

        window.sensorVal = 0;

        async function runCode() {
            if(!isConnected) { alert('–°–ø–æ—á–∞—Ç–∫—É –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –¥–æ Bluetooth!'); return; }
            log('Starting Block Code...', 'info');
            const codeBody = javascript.javascriptGenerator.workspaceToCode(workspace);
            const finalCode = `(async () => { try { ${codeBody} } catch(e){console.log(e); log(e,'err');} })();`;
            try { eval(finalCode); } catch(e) {}
        }
        function stopCode() { currentL = 0; currentR = 0; log('Code Stopped.', 'err'); }

        // === BLUETOOTH ===
        async function sendMoveData(l, r) {
            if (!isConnected || !characteristic) return;
            l = Math.max(-100, Math.min(100, parseInt(l)));
            r = Math.max(-100, Math.min(100, parseInt(r)));
            try { await characteristic.writeValue(new Int8Array([l, r, 10])); } catch(e) { log(e, 'err'); }
        }

        async function sendTextData(str) {
            if (!isConnected || !characteristic) return;
            try { await characteristic.writeValue(new TextEncoder().encode(str + '\n')); log(`Cmd: ${str}`, 'tx'); } catch(e) { log(e, 'err'); }
        }

        btnConnect.addEventListener('click', async () => {
            if(isConnected) { if(device) device.gatt.disconnect(); return; }
            try {
                log('Scanning...', 'info');
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [0xFFE0, "6e400001-b5a3-f393-e0a9-e50e24dcca9e"]
                });
                device.addEventListener('gattserverdisconnected', () => {
                    isConnected = false; statusDot.classList.remove('connected'); statusText.innerText = "OFFLINE";
                    btnConnect.classList.remove('bg-red-600'); btnConnect.classList.add('bg-blue-600');
                    log('Disconnected', 'err');
                });
                const server = await device.gatt.connect();
                let service;
                try { service = await server.getPrimaryService(0xFFE0); characteristic = await service.getCharacteristic(0xFFE1); } 
                catch(e) { service = await server.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e"); characteristic = await service.getCharacteristic("6e400002-b5a3-f393-e0a9-e50e24dcca9e"); }

                try {
                    await characteristic.startNotifications();
                    characteristic.addEventListener('characteristicvaluechanged', (e) => {
                        const str = new TextDecoder().decode(e.target.value).trim();
                        log(str, 'rx');
                        let val = parseFloat(str.replace('S:', ''));
                        if(!isNaN(val)) { window.sensorVal = val; document.getElementById('sensorValDisplay').innerText = val; }
                    });
                } catch(e){}

                isConnected = true; statusDot.classList.add('connected'); statusText.innerText = "ONLINE";
                btnConnect.classList.remove('bg-blue-600'); btnConnect.classList.add('bg-red-600');
                log('Connected!', 'info');
            } catch(e) { log(e, 'err'); }
        });
    </script>
</body>
</html>
