<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STM32 Universal Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Додаємо іконки -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            overscroll-behavior: none;
            touch-action: none;
            user-select: none;
            font-family: 'Segoe UI', Roboto, sans-serif;
            background-color: #0f172a; /* Slate 900 */
        }
        
        /* Ефект скла для панелей */
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Стилі джойстика */
        #joystick-container {
            position: relative;
            width: 260px;
            height: 260px;
            margin: 0 auto;
        }

        #joystick-base {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, rgba(51, 65, 85, 0.5) 0%, rgba(15, 23, 42, 0.8) 70%);
            border: 2px solid rgba(96, 165, 250, 0.3);
            border-radius: 50%;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        #joystick-stick {
            position: absolute;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle at 30% 30%, #60a5fa, #2563eb);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 5px 15px rgba(0,0,0,0.6);
            cursor: grab;
            z-index: 10;
        }

        #joystick-stick::after {
            content: '';
            position: absolute;
            top: 15px;
            left: 15px;
            width: 20px;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
        }

        #joystick-base:active #joystick-stick {
            cursor: grabbing;
            background: radial-gradient(circle at 30% 30%, #f87171, #dc2626);
        }

        /* Анімація з'єднання */
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .status-disconnected { background-color: #ef4444; box-shadow: 0 0 10px #ef4444; }
        .status-connecting { background-color: #f59e0b; animation: pulse 1s infinite; }
        .status-connected { background-color: #22c55e; box-shadow: 0 0 15px #22c55e; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Термінал */
        .terminal-text {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body class="h-screen flex flex-col text-white overflow-hidden">

    <!-- Верхня панель -->
    <header class="p-4 glass-panel m-2 rounded-2xl flex justify-between items-center z-20">
        <div class="flex items-center gap-3">
            <div id="statusIndicator" class="status-dot status-disconnected"></div>
            <div>
                <h1 class="font-bold text-lg leading-tight text-blue-400">RC Controller</h1>
                <div id="statusText" class="text-xs text-slate-400">Відключено</div>
            </div>
        </div>
        <button id="btConnect" class="bg-blue-600 active:bg-blue-700 hover:bg-blue-500 text-white px-5 py-2 rounded-xl font-medium shadow-lg transition-all flex items-center gap-2 text-sm">
            <i class="fa-brands fa-bluetooth-b"></i> <span id="btnText">Пошук</span>
        </button>
    </header>

    <!-- Основна зона керування -->
    <main class="flex-1 flex flex-col items-center justify-center relative w-full">
        
        <!-- Інформація про координати -->
        <div class="absolute top-2 w-full flex justify-center gap-10 text-slate-500 font-mono text-sm pointer-events-none">
            <div class="bg-slate-800/50 px-3 py-1 rounded">X: <span id="posX" class="text-blue-400">0</span></div>
            <div class="bg-slate-800/50 px-3 py-1 rounded">Y: <span id="posY" class="text-blue-400">0</span></div>
        </div>

        <!-- Джойстик -->
        <div id="joystick-container">
            <div id="joystick-base">
                <div id="joystick-stick"></div>
            </div>
            <!-- Стрілки для декору -->
            <div class="absolute top-2 left-1/2 -translate-x-1/2 text-slate-600"><i class="fa-solid fa-chevron-up"></i></div>
            <div class="absolute bottom-2 left-1/2 -translate-x-1/2 text-slate-600"><i class="fa-solid fa-chevron-down"></i></div>
            <div class="absolute left-2 top-1/2 -translate-y-1/2 text-slate-600"><i class="fa-solid fa-chevron-left"></i></div>
            <div class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-600"><i class="fa-solid fa-chevron-right"></i></div>
        </div>

        <p class="mt-6 text-slate-600 text-sm">Перетягуй коло для руху</p>
    </main>

    <!-- Панель налаштувань та пароля -->
    <div class="px-4 pb-2">
        <details class="group glass-panel rounded-xl overflow-hidden transition-all duration-300">
            <summary class="flex justify-between items-center p-3 cursor-pointer bg-slate-800/50 list-none">
                <span class="text-sm font-medium text-slate-300"><i class="fa-solid fa-lock mr-2"></i>Автентифікація / Команди</span>
                <span class="transition group-open:rotate-180"><i class="fa-solid fa-chevron-down text-xs"></i></span>
            </summary>
            <div class="p-3 bg-slate-900/50 space-y-3">
                <div class="text-xs text-slate-400 mb-1">Якщо машинка потребує пароль для розблокування:</div>
                <div class="flex gap-2">
                    <input type="password" id="passInput" placeholder="Введіть пароль" class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500 transition-colors">
                    <button id="sendPassBtn" class="bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i class="fa-solid fa-key"></i>
                    </button>
                </div>
                <!-- Додаткові кнопки -->
                <div class="grid grid-cols-2 gap-2 mt-2">
                    <button onclick="sendCommand('LIGHTS_ON')" class="bg-slate-700 hover:bg-slate-600 p-2 rounded text-xs">Світло ВКЛ</button>
                    <button onclick="sendCommand('LIGHTS_OFF')" class="bg-slate-700 hover:bg-slate-600 p-2 rounded text-xs">Світло ВИКЛ</button>
                </div>
            </div>
        </details>
    </div>

    <!-- Лог термінал -->
    <footer class="h-32 m-2 mb-4 glass-panel rounded-xl flex flex-col overflow-hidden">
        <div class="bg-slate-800/80 px-3 py-1 flex justify-between items-center border-b border-slate-700">
            <span class="text-xs text-slate-400">SYSTEM LOG</span>
            <button onclick="clearLog()" class="text-xs text-slate-500 hover:text-white"><i class="fa-solid fa-trash"></i></button>
        </div>
        <div id="consoleLog" class="flex-1 p-2 overflow-y-auto terminal-text space-y-1 text-slate-300">
            <div class="text-yellow-500">> Готовий до підключення...</div>
            <div class="text-slate-500 italic">> Натисніть "Пошук" зверху</div>
        </div>
    </footer>

    <script>
        // --- Bluetooth Global Variables ---
        let device, server, service, characteristic;
        let isConnected = false;

        // Популярні UUID для UART (Serial)
        // 0xFFE0 - HM-10, AT-09 (найпопулярніші)
        // 0x6E40 - Nordic UART
        const OPTIONAL_SERVICES = [
            0xFFE0, 
            "6e400001-b5a3-f393-e0a9-e50e24dcca9e"
        ];

        // UI елементи
        const statusDot = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const btnConnect = document.getElementById('btConnect');
        const btnText = document.getElementById('btnText');
        const consoleLog = document.getElementById('consoleLog');
        const passInput = document.getElementById('passInput');

        // Логування
        function log(msg, type = 'info') {
            const el = document.createElement('div');
            const time = new Date().toLocaleTimeString().split(' ')[0];
            el.innerHTML = `<span class="opacity-40">[${time}]</span> ${msg}`;
            
            if (type === 'error') el.className = 'text-red-400';
            else if (type === 'tx') el.className = 'text-blue-400';
            else if (type === 'rx') el.className = 'text-green-400';
            else el.className = 'text-slate-300';

            consoleLog.appendChild(el);
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }

        function clearLog() { consoleLog.innerHTML = ''; }

        // --- Bluetooth Connection Logic ---
        
        async function toggleConnection() {
            if (isConnected) {
                disconnect();
            } else {
                connect();
            }
        }

        async function connect() {
            try {
                updateStatus('connecting');
                log('Сканування пристроїв (Виберіть зі списку)...');

                // 1. Запит пристрою (Показує всі пристрої поруч)
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: OPTIONAL_SERVICES
                });

                device.addEventListener('gattserverdisconnected', onDisconnected);
                
                log(`Вибрано: ${device.name || 'Без імені'}`);
                log('Підключення до GATT сервера...');

                // 2. Підключення
                server = await device.gatt.connect();
                
                // 3. Пошук сервісу UART
                // Спробуємо знайти правильний сервіс перебором
                service = null;
                
                try {
                    // Спроба HM-10
                    service = await server.getPrimaryService(0xFFE0);
                    log('Знайдено сервіс HM-10 (FFE0)');
                    characteristic = await service.getCharacteristic(0xFFE1);
                } catch (e) {
                    try {
                        // Спроба Nordic
                        service = await server.getPrimaryService("6e400001-b5a3-f393-e0a9-e50e24dcca9e");
                        log('Знайдено сервіс Nordic UART');
                        characteristic = await service.getCharacteristic("6e400002-b5a3-f393-e0a9-e50e24dcca9e"); // TX characteristic
                    } catch (e2) {
                         throw new Error("Не знайдено сумісний UART сервіс (HM-10 або Nordic). Перевірте UUID.");
                    }
                }

                if (!characteristic) throw new Error("Характеристика для запису не знайдена");

                // 4. Успіх
                isConnected = true;
                updateStatus('connected');
                log('Готово! Можна керувати.', 'rx');

                // Можна спробувати включити сповіщення (читання відповіді від машинки)
                try {
                    // Для HM-10 читання і запис часто на одній характеристиці, для Nordic - на різних
                    // Тут спрощений варіант
                    await characteristic.startNotifications();
                    characteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                } catch(e) {
                    log('Читання даних недоступне (тільки запис)');
                }

            } catch (error) {
                log(error, 'error');
                updateStatus('disconnected');
            }
        }

        function disconnect() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
        }

        function onDisconnected() {
            isConnected = false;
            updateStatus('disconnected');
            log('Пристрій відключено', 'error');
        }

        function updateStatus(state) {
            if (state === 'connecting') {
                statusDot.className = 'status-dot status-connecting';
                statusText.innerText = 'Підключення...';
                btnText.innerText = 'Скасування';
            } else if (state === 'connected') {
                statusDot.className = 'status-dot status-connected';
                statusText.innerText = 'Підключено до ' + (device ? device.name : 'Unknown');
                btnText.innerText = 'Відключити';
                btnConnect.classList.replace('bg-blue-600', 'bg-red-600');
                btnConnect.classList.replace('hover:bg-blue-500', 'hover:bg-red-500');
            } else {
                statusDot.className = 'status-dot status-disconnected';
                statusText.innerText = 'Відключено';
                btnText.innerText = 'Пошук';
                btnConnect.classList.replace('bg-red-600', 'bg-blue-600');
                btnConnect.classList.replace('hover:bg-red-500', 'hover:bg-blue-500');
            }
        }

        btnConnect.addEventListener('click', toggleConnection);

        // --- Data Sending ---
        let lastSend = 0;
        const SEND_INTERVAL = 100; // ms

        async function sendCommand(cmd) {
            if (!isConnected || !characteristic) {
                log('Не підключено!', 'error');
                return;
            }
            try {
                // Додаємо перенос рядка, бо STM32 часто читає до \n
                const data = cmd + '\n';
                const encoder = new TextEncoder();
                await characteristic.writeValue(encoder.encode(data));
                log(`TX: ${cmd}`, 'tx');
            } catch (e) {
                log('Помилка відправки: ' + e, 'error');
            }
        }

        // Кнопка відправки пароля
        document.getElementById('sendPassBtn').addEventListener('click', () => {
            const pass = passInput.value;
            if(pass) {
                // Формат команди пароля (зміни під свою прошивку)
                // Наприклад: PASS:1234
                sendCommand(`PASS:${pass}`); 
                passInput.value = '';
            }
        });

        // Обробка вхідних даних (від машинки)
        function handleNotifications(event) {
            const value = event.target.value;
            const decoder = new TextDecoder('utf-8');
            log(`RX: ${decoder.decode(value).trim()}`, 'rx');
        }


        // --- Joystick Logic ---
        const joystickBase = document.getElementById('joystick-base');
        const joystickStick = document.getElementById('joystick-stick');
        const container = document.getElementById('joystick-container');
        const posX = document.getElementById('posX');
        const posY = document.getElementById('posY');

        let dragging = false;
        let joyCenter = { x: 0, y: 0 };
        const maxDist = 90; // Радіус обмеження

        function startJoy(e) {
            dragging = true;
            joystickStick.style.transition = 'none';
            const rect = joystickBase.getBoundingClientRect();
            joyCenter = {
                x: rect.left + rect.width / 2,
                y: rect.top + rect.height / 2
            };
        }

        function endJoy() {
            dragging = false;
            joystickStick.style.transition = 'transform 0.2s ease-out';
            joystickStick.style.transform = `translate(-50%, -50%) translate(0px, 0px)`;
            
            // Send STOP
            posX.innerText = '0';
            posY.innerText = '0';
            sendCommand('X:0,Y:0');
        }

        function moveJoy(e) {
            if (!dragging) return;
            e.preventDefault();

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const dx = clientX - joyCenter.x;
            const dy = clientY - joyCenter.y;
            
            const distance = Math.min(Math.hypot(dx, dy), maxDist);
            const angle = Math.atan2(dy, dx);

            const moveX = Math.cos(angle) * distance;
            const moveY = Math.sin(angle) * distance;

            joystickStick.style.transform = `translate(-50%, -50%) translate(${moveX}px, ${moveY}px)`;

            // Map to -100 to 100
            // Inverting Y because screen Y goes down
            const valX = Math.round((moveX / maxDist) * 100);
            const valY = Math.round((moveY / maxDist) * 100) * -1;

            posX.innerText = valX;
            posY.innerText = valY;

            // Rate limiting sending
            const now = Date.now();
            if (now - lastSend > SEND_INTERVAL) {
                sendCommand(`X:${valX},Y:${valY}`);
                lastSend = now;
            }
        }

        joystickBase.addEventListener('mousedown', startJoy);
        joystickBase.addEventListener('touchstart', startJoy);

        window.addEventListener('mouseup', endJoy);
        window.addEventListener('touchend', endJoy);

        window.addEventListener('mousemove', moveJoy);
        window.addEventListener('touchmove', moveJoy, { passive: false });

    </script>
</body>
</html>
